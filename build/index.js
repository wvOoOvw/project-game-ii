(()=>{var t={652:()=>{!function(){const t=canvas.width,e=canvas.height;canvas.width=Math.round(2*t),canvas.height=Math.round(2*e),canvas.style.width=t+"px",canvas.style.height=e+"px",window.dpr=2,canvas.getContext("2d").scale(2,2)}()},37:()=>{window.fontFamily="Courier"},293:()=>{!function(){if(window.wx)return;window.wx={getSystemInfoSync:()=>({safeArea:{top:0},windowWidth:document.querySelector("canvas").clientWidth,windowHeight:document.querySelector("canvas").clientHeight})};const t=document.querySelector("body");t.style.padding="0",t.style.margin="auto",t.style.left=0,t.style.right=0,t.style.top=0,t.style.bottom=0,t.style.position="absolute",t.style.width="100%",t.style.height="100%";const e=document.createElement("canvas");e.width=t.clientWidth,e.height=t.clientHeight,e.style.display="block",e.style.touchAction="none",t.appendChild(e),window.canvas=e}()},6:()=>{!function(){const t=Symbol("_Allow");function e(t){this.ImitationINS=t,this.dependentQueue=[],this.monitorQueue=[]}function i(t){this.state=t,this.MonitorINS=new e(this)}e.prototype.dispatch=function(){this.monitorQueue.forEach(((e,i)=>{const s=this.dependentQueue[i],n=this.executeDependent(e.dependent);return n===t||Array.isArray(n)&&Array.isArray(s)&&(h=n,a=s,Array.isArray(h)&&Array.isArray(a)&&(h.length!==a.length||h.filter(((t,e)=>t===a[e])).length!==h.length))||!Array.isArray(n)&&!Array.isArray(s)&n!==s?(this.executeEvent(e.event),void(this.dependentQueue[i]=n)):void(this.dependentQueue[i]=n);var h,a}))},e.prototype.register=function(e,i=t){const s={event:e,dependent:i};return this.monitorQueue.push(s),this.dependentQueue.push(this.executeDependent(i)),()=>{this.monitorQueue.forEach(((t,e)=>{t===s&&(this.monitorQueue=this.monitorQueue.filter(((t,i)=>i!==e)),this.dependentQueue=this.dependentQueue.filter(((t,i)=>i!==e)))}))}},e.prototype.executeEvent=function(t){t(this.ImitationINS.state)},e.prototype.executeDependent=function(t){return"function"==typeof t?t(this.ImitationINS.state):t},i.prototype.setState=function(t){this.state="function"==typeof t?t(this.state):t,this.dispatch()},i.prototype.assignState=function(t){this.state=Object.assign(this.state,"function"==typeof t?t(this.state):t),this.dispatch()},i.prototype.register=function(){return this.MonitorINS.register(...arguments)},i.prototype.dispatch=function(){return this.MonitorINS.dispatch(...arguments)};const s=new i;window.Imitation=s}()}},e={};function i(s){var n=e[s];if(void 0!==n)return n.exports;var h=e[s]={exports:{}};return t[s](h,h.exports,i),h.exports}(()=>{"use strict";i(293),i(652),i(37),i(6);const t="build/music_ff2679ad919b47bcbb8968bd92fd8dd10.jpeg",e="build/music_47a83799595b4a5b97145a6e594620310.jpeg";var s=[{key:1,name:"金币",image:"build/music_16193381303a4584989ac395336fd4880.jpeg"},{key:2,name:"钻石",image:"build/music_a7e9436348e6456eb47f32a75f7392370.jpeg"},{key:3,name:"碎片",image:"build/music_a2835cfbbeea40d6971fd36c0a44870d0.jpeg"}];s=s.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));var n=[{key:1,name:"艾露恩",image:"build/music_1107cbd537144759999fbd7dc0fdb6650.jpg",HP:t=>900+100*t,MP:t=>190+10*t,skill:[{name:"庇护 I",description:t=>`使用卡牌时, 回复 ${15*t} MP`,function:(t,e,i,s,n)=>{e.push({effect:"cure-mp",target:"self",value:15*i.master.level})}},{name:"庇护 II",description:t=>`使用卡牌时, 回复 ${15*t} HP`,function:(t,e,i,s,n)=>{e.push({effect:"cure-hp",target:"self",value:15*i.master.level})}}]},{key:2,name:"火焰领主",image:"build/music_b6f0b1c512ad42fab204d79b85d07c140.jpeg",HP:t=>900+100*t,MP:t=>190+10*t,skill:[{name:"欲火",description:t=>`使用火系卡牌时, 额外造成 ${15*t} 伤害`,function:(t,e,i,s,n)=>{"火"===t.race&&e.push({effect:"hit",target:"opposite",value:15*-i.master.level})}}]}];n=n.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));var h=[{key:1,name:"小火把",type:"进攻卡",race:"火",limit:3,image:"build/music_88c8411d068c455099456851ec84f65c0.jpeg",description:t=>`造成 ${20*t+80} 伤害, 并附加给目标 1 层'燃'`,function:(t,e,i,s)=>[{animation:"red-hit",target:"opposite"},{effect:"hit",target:"opposite",value:20*t.level+80},{effect:"buff",target:"opposite",value:"燃",number:1}]},{key:2,name:"大火把",type:"进攻卡",race:"火",limit:3,image:"build/music_2fec7f9242b44b64a914f7cc19d25abe0.jpeg",description:t=>`造成 ${10*t+40} 伤害, 并附加给目标 2 层'燃'`,function:(t,e,i,s)=>[{animation:"red-hit",target:"opposite"},{effect:"hit",target:"opposite",value:10*t.level+40},{effect:"buff",target:"opposite",value:"燃",number:2}]},{key:3,name:"点燃",type:"魔法卡",race:"火",limit:3,image:"build/music_4d7f219082ba4d86b1543c982d1156560.jpeg",description:t=>`消耗 100 MP, 造成目标'燃'层数 * ${5*t+20} 伤害`,function:(t,e,i,s)=>e.MP<100?[{error:"MP 不足"}]:[{animation:"red-hit",target:"opposite"},{effect:"cost-mp",target:"self",value:100},{effect:"hit",target:"opposite",value:i.master.buff.reduce(((t,e)=>"燃"===e?t+1:t),0)*(5*t.level+20)}]},{key:4,name:"火之纽带",type:"魔法卡",race:"火",limit:3,image:"build/music_6e9e96c75cf04411baa154b1d6a3c7360.jpeg",description:t=>`从牌库以及墓地抽取 1 张除自身外的火系卡牌, 回复 ${5*t+20} MP`,function:(t,e,i,s)=>{const n=[{animation:"red-hit",target:"self"},{effect:"cure-mp",target:"self",value:5*t.level+20}],h=e.card.store.find((e=>"火"===e.race&&e.key!==t.key));h&&n.push({effect:"pump-store-point",target:"self",value:[h]});const a=e.card.cemetery.find((e=>"火"===e.race&&e.key!==t.key));return a&&n.push({effect:"pump-cemetery-point",target:"self",value:[a]}),n}},{key:5,name:"引燃",type:"魔法卡",race:"火",limit:3,image:"build/music_98a7a38ce58546a7841d18c96e41e3760.jpeg",description:t=>`消耗 20 MP, 造成 ${30*t+120} 伤害, 并消耗目标 1 层'燃'`,function:(t,e,i,s)=>e.MP<20?[{error:"MP 不足"}]:i.master.buff.find((t=>"燃"===t))?[{animation:"red-hit",target:"opposite"},{effect:"cost-mp",target:"self",value:20},{effect:"hit",target:"opposite",value:30*t.level+120},{effect:"cost-buff",target:"opposite",value:"燃",number:1}]:[{error:"目标'燃'印记不足"}]},{key:6,name:"火焰冲击",type:"进攻卡",race:"火",limit:3,image:"build/music_c753fd717be543eaa25f4a1aa9240d7d0.jpeg",description:t=>`造成 ${20*t+80} 伤害, 若目标拥有'燃'则伤害 * 1.5`,function:(t,e,i,s)=>[{animation:"red-hit",target:"opposite"},{effect:"hit",target:"opposite",value:i.master.buff.find((t=>"燃"===t))?1.5*(20*t.level+80):20*t.level+80}]},{key:7,name:"火焰聚能",type:"治疗卡",race:"火",limit:3,image:"build/music_c12894d6ce644a37a16069502d98c9b80.jpeg",description:t=>`吸收对手的所有'燃', 每有一层回复自身 ${20*t+30} HP`,function:(t,e,i,s)=>[{animation:"red-hit",target:"opposite"},{effect:"cure-hp",target:"opposite",value:i.master.buff.reduce(((t,e)=>"燃"===e?t+1:t),0)*(20*t.level+30)}]}];h=h.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));var a=[{name:"故事 I",description:"梦境守卫",type:"alltime",image:e,boss:{master:{key:1,level:1},card:[{key:1,level:1,number:10},{key:2,level:1,number:10}]},reward:()=>[{money:!0,key:1,number:1e3}],AI:(t,e,i)=>m(t.card.hand,1)},{name:"梦境 I",description:"梦境守卫",type:"alltime",image:e,boss:{master:{key:2,level:2},card:[{key:1,level:3,number:10},{key:2,level:3,number:10},{key:3,level:3,number:10}]},reward:()=>[{card:!0,key:1,level:1,number:Math.floor(3*Math.random())},{card:!0,key:2,level:1,number:Math.floor(3*Math.random())}],AI:(t,e,i)=>m(t.card.hand,1)}];a=a.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));var o=[{name:"火系基础礼盒I",description:"可能包含: 小火把(等级1)2-5张, 大火把(等级1)2-5张",type:"alltime",image:t,money:{key:1,number:1e3},reward:()=>[{card:!0,key:1,level:1,number:Math.floor(4*Math.random()+2)},{card:!0,key:2,level:1,number:Math.floor(4*Math.random()+2)},{card:!0,key:4,level:1,number:Math.floor(4*Math.random()+2)}]},{name:"火系基础礼盒II",description:"可能包含: 点燃(等级1)2-5张, 引燃(等级1)2-5张, 火焰领主经验50-100",type:"alltime",image:t,money:{key:2,number:1e3},reward:()=>[{card:!0,key:3,level:1,number:Math.floor(4*Math.random()+2)},{card:!0,key:5,level:1,number:Math.floor(4*Math.random()+2)},{master:!0,key:2,number:Math.floor(50*Math.random()+50)}]}];o=o.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));const r=(t,e)=>t.reduce(((t,i)=>{const s=[...t],n=h.find((t=>i.key===t.key));if(e){const t={...n,...i};delete t.number,s.push(...new Array(i.number).fill().map((e=>({...t}))))}return e||s.push({...n,...i}),s}),[]),l=t=>t.reduce(((t,e)=>{const i=[...t],s=n.find((t=>e.key===t.key));return i.push({...s,...e,HP:s.HP(e.level),MP:s.MP(e.level)}),i}),[]),d=t=>t.reduce(((t,e)=>{const i=[...t],n=s.find((t=>e.key===t.key));return i.push({...n,...e}),i}),[]),c=t=>1===t?"I":2===t?"II":3===t?"III":4===t?"IV":5===t?"V":6===t?"VI":7===t?"VII":8===t?"VIII":9===t?"IX":10===t?"X":11===t?"XI":12===t?"XII":13===t?"XIII":14===t?"XIV":15===t?"XV":16===t?"XVI":void 0,f=async t=>await new Promise((e=>setTimeout((()=>e()),t))),w=t=>Number(Number(t).toFixed(2)),m=(t,e)=>{var i=[],s=[...t];return new Array(e).fill().forEach((()=>{const t=Math.floor(Math.random()*s.length);s[t]&&(i.push(s[t]),s=s.filter(((e,i)=>i!==t)))})),i},u=t=>{for(var e=[],i=[...t];i.length;){const t=Math.floor(Math.random()*i.length);e.push(i[t]),i=i.filter(((e,i)=>i!==t))}return e},g=(t,e,i)=>{const s=t=>p(t,i)?e(t):null;canvas.addEventListener(t,s,{passive:!0}),Imitation.state.removeEventListener.push((()=>canvas.removeEventListener(t,s)))},y=(t,e)=>{const i=t=>e(t);canvas.addEventListener(t,i,{passive:!0}),Imitation.state.removeEventListener.push((()=>canvas.removeEventListener(t,i)))},p=(t,e)=>{const i=e.x,s=e.y,n=e.width,h=e.height,a=t.x||t.touches[0].clientX,o=t.y||t.touches[0].clientY;return a>=i&&a<=i+n&&o>=s&&o<=s+h},x=(t,e)=>{const{x:i,y:s,width:n,height:h}=t,{x:a,y:o,width:r,height:l}=e;return i+n>a&&i<a+r&&s+h>o&&s<o+l},v=t=>{const e=new Image;return e.src=t,e},b=canvas.getContext("2d"),I=(t,e)=>{const i=e.x,s=e.y,n=e.width,h=e.height;var a=0,o=0,r=t.width,l=t.height;const d=Math.max(n/t.width,h/t.height),c=t.width*d-n,f=t.height*d-h;c&&(a=c/2/d,r-=c/d),f&&(o=f/2/d,l-=f/d),b.drawImage(t,a,o,r,l,i,s,n,h)},S=t=>{const e=t.x,i=t.y,s=t.width,n=t.height,h=Array.isArray(t.radius)?t.radius:new Array(4).fill(t.radius);b.beginPath(),b.moveTo(e,i+h[0]),b.arcTo(e,i,e+h[0],i,h[0]),b.lineTo(e+s-h[1],i),b.arcTo(e+s,i,e+s,i+h[1],h[1]),b.lineTo(e+s,i+n-h[2]),b.arcTo(e+s,i+n,e+s-h[2],i+n,h[2]),b.lineTo(e+h[3],i+n),b.arcTo(e,i+n,e,i+n-h[3],h[3]),b.closePath()},T=t=>{const e=t.x,i=t.y,s=t.width,n=t.fontHeight;let h=t.text.split(""),a="",o=[];h.forEach((t=>{b.measureText(a).width>s&&(o.push(a),a=""),a+=t})),o.push(a),o.forEach(((t,s)=>{b.fillText(t,e,i+s*n)}))},M=canvas.getContext("2d"),A=v("build/music_8abd849fe01a4fb68dceacc6018190fc0.jpeg"),$=wx.getSystemInfoSync().windowWidth,P=wx.getSystemInfoSync().windowHeight,k=class{constructor(){this.opacity=0,this.count=0}render(){if(this.count<=20&&(this.opacity=w(this.opacity+.05),this.count=this.count+1),this.count>20&&this.count<=40&&(this.count=this.count+1),this.count>40&&this.count<=60&&(this.opacity=w(this.opacity-.05),this.count=this.count+1),this.count>60)return Imitation.state.page.current=Imitation.state.page.next,void(Imitation.state.page.next="");M.globalAlpha=this.opacity,I(A,{x:0,y:0,width:$,height:P}),M.globalAlpha=1}},C=canvas.getContext("2d");class E{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.radius=t.radius,this.font=t.font,this.fillStyle=t.fillStyle,this.text=t.text}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}render(){C.save(),C.textAlign="center",C.textBaseline="middle",C.font=this.font,C.fillStyle=this.fillStyle[0],S({x:this.x,y:this.y,width:this.width,height:this.height,radius:this.radius}),C.fill(),C.fillStyle=this.fillStyle[1],C.fillText(this.text,this.x+this.width/2,this.y+this.height/2),C.restore()}}canvas.getContext("2d");const D=v("build/music_56280e428411459c823ce172d97da20c0.jpeg"),B=wx.getSystemInfoSync().windowWidth,F=wx.getSystemInfoSync().windowHeight,H=class{constructor(){}drawButtonExplore(){const t={x:B/2-60,y:F-240,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"探索"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="explore"}),t)}drawButtonStore(){const t={x:B/2-60,y:F-180,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"编队"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="store"}),t)}drawButtonShop(){const t={x:B/2-60,y:F-120,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"商店"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="shop"}),t)}render(){I(D,{x:0,y:0,width:B,height:F}),this.drawButtonExplore(),this.drawButtonStore(),this.drawButtonShop()}},R=canvas.getContext("2d");class O{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.radius=t.radius,this.scrollX=t.scrollX||0,this.scrollY=t.scrollY||0,this.scrollPosition=[0,0],this.mouseDownPosition=null,this.clipFunction=()=>{const t={x:this.x,y:this.y,width:this.width,height:this.height,radius:this.radius};return S(t),t}}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}eventDown(t){try{this.mouseDownPosition=[t.x||t.touches[0].clientX,t.y||t.touches[0].clientY]}catch{}}eventUp(t){this.mouseDownPosition=null}eventMove(t){if(!this.mouseDownPosition)return;if(this.scrollX<=0&&this.scrollY<=0)return;clearTimeout(this.scrollbarTimeout),this.scrollbarTimeout=setTimeout((()=>this.scrollbarTimeout=null),1e3);const e=(t.pageX||t.targetTouches[0].pageX)-this.mouseDownPosition[0],i=(t.pageY||t.targetTouches[0].pageY)-this.mouseDownPosition[1];this.mouseDownPosition=[this.mouseDownPosition[0]+e,this.mouseDownPosition[1]+i];var s=this.scrollPosition[0]-e,n=this.scrollPosition[1]-i;this.scrollX>0&&(s<=0&&(s=0),s>this.scrollX&&(s=this.scrollX)),this.scrollY>0&&(n<=0&&(n=0),n>this.scrollY&&(n=this.scrollY)),this.scrollPosition=[s,n]}render(t){R.save();const e=this.clipFunction();R.clip(),t(this.scrollPosition),R.restore(),g("touchstart",this.eventDown.bind(this),e),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}const Y="build/music_1c31bcc267a545ef971109512053f3e50.jpeg",X=canvas.getContext("2d"),N=v(Y),j=wx.getSystemInfoSync().safeArea.top,L=wx.getSystemInfoSync().windowWidth,U=wx.getSystemInfoSync().windowHeight;class _{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.explore=t.explore,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.35*i,h=.07*i,a=t+.03*i,o=e+.03*i;S({x:a,y:o,width:n,height:h,radius:.02*i}),X.fillStyle="rgba(255, 255, 255, 0.75)",X.fill(),X.textAlign="center",X.textBaseline="middle",X.font=`900 ${.025*i}px ${window.fontFamily}`,X.fillStyle="rgba(0, 0, 0, 1)",X.fillText("EXPLORE 探索",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.explore,h=.35*i,a=.07*i,o=t+i-h-.03*i,r=e+s-a-.03*i;S({x:o,y:r,width:h,height:a,radius:.02*i}),X.fillStyle="rgba(255, 255, 255, 0.75)",X.fill(),X.textAlign="center",X.textBaseline="middle",X.font=`900 ${.025*i}px ${window.fontFamily}`,X.fillStyle="rgba(0, 0, 0, 1)",X.fillText(n.name,o+h/2,r+a/2)}render(){const t=this.x+this.offsetX,e=this.y+this.offsetY,i=this.width,s=this.height;this.explore,X.save(),S({x:t,y:e,width:i,height:s,radius:12}),X.clip(),I(this.explore.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),X.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}const Q=class{constructor(){this.type="alltime",this.explore,this.InstanceScroll,this.InstanceExplore,this.init()}get bannerHeight(){return 54}get exploreHeight(){const t=this.explore.length;return 0===t?-12:(L-60)/4*1.35*t+(t?12*(t-1):0)}init(){this.explore=Imitation.state.explore.filter((t=>t.type===this.type)),this.instanceScroll(),this.instanceExplore()}instanceScroll(){const t={x:12,y:60+j,width:L-24,height:U-72-j,radius:12};this.InstanceScroll=new O(t),this.InstanceScroll.scrollY=this.bannerHeight-this.InstanceScroll.height+24}instanceExplore(){this.InstanceExplore=this.explore.map(((t,e)=>{const i={width:L-24,explore:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.enter(t)};return i.height=(L-60)/4*1.35,i.x=12,i.y=72+e*(i.height+12)+this.bannerHeight+j,new _(i)}))}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawBanner(e),this.drawExplore(e)}))}drawBanner(t){const e={x:12,y:60-t+j,width:L-24,height:this.bannerHeight,radius:12};x(e,this.InstanceScroll.option)&&(X.save(),S(e),X.fillStyle="rgba(0, 0, 0, 0.25)",X.fill(),X.clip(),new Array(["alltime","常驻"],["week_"+(new Date).getDay(),"周活动"]).forEach(((t,i)=>{const s={x:24+84*i,y:12+e.y,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,text:t[1]};s.fillStyle=t[0]===this.type?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.type=t[0],this.init())}),s))})),X.restore())}drawExplore(t){this.InstanceExplore.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawPreview(){var t=[];const e=this.InstanceExplorePreview.y+this.InstanceExplorePreview.height;this.InstanceExplorePreview.explore=this.preview,this.InstanceExplorePreview.render();const i={x:L/2-60,y:e+40,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"购买"};new E(i).render(),g("touchstart",(()=>{this.buy(this.preview),this.preview=null,this.InstanceExplorePreview.novaTime=0}),i),t.push(i),y("touchstart",(e=>{t.some((t=>p(e,t)))||(this.preview=null,this.InstanceExplorePreview.novaTime=0)}))}drawButtonHome(){const t={x:12,y:12+j,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}enter(t){Imitation.state.battle={self:{master:{...l([Imitation.state.info.library.master.find((t=>t.key===Imitation.state.info.team[Imitation.state.info.teamIndex].master[0].key))])[0],buff:[]},card:{team:r(Imitation.state.info.team[Imitation.state.info.teamIndex].card,!0),store:u(r(Imitation.state.info.team[Imitation.state.info.teamIndex].card,!0)),hand:[],cemetery:[],consume:[]}},opposite:{master:{...l([t.boss.master])[0],buff:[]},card:{team:r(t.boss.card,!0),store:u(r(t.boss.card,!0)),hand:[],cemetery:[],consume:[]},AI:t.AI},reward:t.reward},Imitation.state.battle.self.card.team.length<20||Imitation.state.battle.self.card.team.length>40?Imitation.state.function.message("卡组数量必须在20-40内","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):(Imitation.state.page.current="transition",Imitation.state.page.next="battle-pve")}render(){I(N,{x:0,y:0,width:L,height:U}),this.drawButtonHome(),this.drawScroll()}},W=canvas.getContext("2d"),V=v(Y),q=wx.getSystemInfoSync().safeArea.top,J=wx.getSystemInfoSync().windowWidth,z=wx.getSystemInfoSync().windowHeight;class G{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.card=t.card,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",W.fillText("CARD 卡牌",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i,l=.03*i,d=[n.name,c(n.level)];n.number&&d.push("x"+n.number),S({x:o,y:r,width:h,height:a,radius:l}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",W.fillText(d.join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card;W.save(),S({x:t,y:e,width:i,height:s,radius:8}),W.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),W.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}class K{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.card=t.card,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",W.fillText("CARD 卡牌",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i,l=.03*i,d=[n.name,c(n.level)];n.number&&d.push("x"+n.number),S({x:o,y:r,width:h,height:a,radius:l}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",W.fillText(d.join(" "),o+h/2,r+a/2)}drawRace(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=.12*i,o=t+.05*i,r=e+.22*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",W.fillText(n.race,o+h/2,r+a/2)}drawType(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=.12*i,o=t+.05*i,r=e+.39*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",W.fillText(n.type,o+h/2,r+a/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=t+.05*i,o=e+.56*i;S({x:a,y:o,width:h,height:.57*i,radius:.03*i}),W.fillStyle="rgba(255, 255, 255, 0.75)",W.fill(),W.textAlign="start",W.textBaseline="top",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle="rgba(0, 0, 0, 1)",T({x:a+.05*i,y:o+.05*i,width:h-.12*i,fontHeight:.075*i,text:n.description(n.level)})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const{x:t,y:e,width:i,height:s}=this.option,n=this.card;W.save(),S({x:t,y:e,width:i,height:s,radius:.08*i}),W.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),this.drawRace(),this.drawType(),this.drawDescription(),W.restore()}}class Z{constructor(t){this.preview=null,this.card=[],this.title="",this.sort="name",this.back=t.back,this.InstanceScroll,this.InstanceCardList,this.InstanceCardPreview,this.instanceScroll(),this.instanceCardPreview()}get bannerHeight(){return 96}get cardHeight(){const t=Math.ceil(this.card.length/4);return 0===t?0:(J-60)/4*1.35*t+(t?12*(t-1):0)}init(){this.card=this.card.sort(((t,e)=>{const i=String(t[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0);return String(e[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0)-i})),this.instanceScroll(),this.instanceCardList(),this.instanceCardPreview()}instanceScroll(){const t={x:12,y:60+q,width:J-24,height:z-72-q,radius:12};this.InstanceScroll=new O(t)}instanceCardList(){this.InstanceCardList=this.card.map(((t,e)=>{const i={width:(J-60)/4,card:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=1.35*i.width,i.x=12+parseInt(e%4)*(i.width+12),i.y=72+parseInt(e/4)*(i.height+12)+this.bannerHeight+q,new G(i)}))}instanceCardPreview(){const t={};t.width=.7*J,t.height=1.35*t.width,t.x=.15*J,t.y=(z-1.5*t.width)/2-60,this.InstanceCardPreview=new K(t)}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawBanner(e),this.drawCard(e)}))}drawBanner(t){const e={x:12,y:60-t+q,width:J-24,height:this.bannerHeight,radius:12};if(x(e,this.InstanceScroll.option)){W.save(),S(e),W.fillStyle="rgba(0, 0, 0, 0.25)",W.fill(),W.clip();{const t={x:24,y:12+e.y,width:J-48,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"],text:this.title};new E(t).render()}new Array(["name","名称"],["level","等级"],["type","类型"],["race","种类"]).forEach(((t,i)=>{const s={x:24+72*i,y:54+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:t[0]===this.sort?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:t[1]};x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.sort=t[0],this.init())}),s))})),W.restore()}}drawCard(t){this.InstanceCardList.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawPreview(){this.InstanceCardPreview.card=this.preview,this.InstanceCardPreview.render(),y("touchstart",(t=>{this.preview=null,this.InstanceCardPreview.novaTime=0}))}drawButtonHome(){const t={x:12,y:12+q,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new E(t).render(),g("touchstart",this.back,t)}render(){this.InstanceScroll.scrollY=this.bannerHeight+this.cardHeight-this.InstanceScroll.height+12,I(V,{x:0,y:0,width:J,height:z}),this.preview&&this.drawPreview(),this.preview||(this.drawButtonHome(),this.drawScroll())}}class tt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.novaTime=0,this.card=t.card}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const t=this.x,e=this.y,i=this.width,s=this.height;W.save(),W.globalAlpha=this.novaTime,S({x:t,y:e,width:i,height:s,radius:.08*i}),W.clip(),I(V,{x:t,y:e,width:i,height:s}),W.restore()}}class et{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.card=t.card,this.touchStart=t.touchStart,this.touchEnd=t.touchEnd,this.useAble=t.useAble,this.mouseDownPosition=null,this.novaTime=0,this.ifTouchEndTime=0,this.mouseDownPositionTime=0,this.useAbleTime=0}get ifTouchEnd(){return this.offsetY<0-this.height/2}get option(){const t=.5*-this.width,e=.5*-this.height,i=this.width,s=this.height;return{x:this.x+this.offsetX+t*this.mouseDownPositionTime,y:this.y+this.offsetY+e*this.mouseDownPositionTime,width:this.width+i*this.mouseDownPositionTime,height:this.height+s*this.mouseDownPositionTime}}eventDown(t){try{this.mouseDownPosition=[t.x||t.touches[0].clientX,t.y||t.touches[0].clientY],this.touchStart()}catch{}}eventUp(t){this.ifTouchEnd&&this.touchEnd(),this.mouseDownPosition=null,this.offsetX=0,this.offsetY=0}eventMove(t){if(!this.mouseDownPosition)return;const e=(t.pageX||t.targetTouches[0].pageX)-this.mouseDownPosition[0],i=(t.pageY||t.targetTouches[0].pageY)-this.mouseDownPosition[1];this.mouseDownPosition=[this.mouseDownPosition[0]+e,this.mouseDownPosition[1]+i],this.offsetX=this.offsetX+e,this.offsetY=this.offsetY+i}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=this.ifTouchEndTime,h=.5*i,a=.12*i,o=t+.05*i,r=e+.05*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),W.fillStyle=`rgba(${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, 0.75)`,W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle=`rgba(${Math.floor(255*n)}, ${Math.floor(255*n)}, ${Math.floor(255*n)}, 1)`,W.fillText("CARD 卡牌",o+h/2,r+a/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.ifTouchEndTime,h=this.card,a=.5*i,o=.12*i,r=t+i-a-.05*i,l=e+s-o-.05*i,d=.03*i,f=[h.name,c(h.level)];h.number&&f.push("x"+h.number),S({x:r,y:l,width:a,height:o,radius:d}),W.fillStyle=`rgba(${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, 0.75)`,W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle=`rgba(${Math.floor(255*n)}, ${Math.floor(255*n)}, ${Math.floor(255*n)}, 1)`,W.fillText(f.join(" "),r+a/2,l+o/2)}drawRace(){const{x:t,y:e,width:i,height:s}=this.option,n=this.ifTouchEndTime,h=this.card,a=.9*i,o=.12*i,r=t+.05*i,l=e+.22*i;S({x:r,y:l,width:a,height:o,radius:.03*i}),W.fillStyle=`rgba(${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, 0.75)`,W.fill(),W.textAlign="center",W.textBaseline="middle",W.fillStyle=`rgba(${Math.floor(255*n)}, ${Math.floor(255*n)}, ${Math.floor(255*n)}, 1)`,W.fillText(h.race,r+a/2,l+o/2)}drawType(){const{x:t,y:e,width:i,height:s}=this.option,n=this.ifTouchEndTime,h=this.card,a=.9*i,o=.12*i,r=t+.05*i,l=e+.39*i;S({x:r,y:l,width:a,height:o,radius:.03*i}),W.fillStyle=`rgba(${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, 0.75)`,W.fill(),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle=`rgba(${Math.floor(255*n)}, ${Math.floor(255*n)}, ${Math.floor(255*n)}, 1)`,W.fillText(h.type,r+a/2,l+o/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.ifTouchEndTime,h=this.card,a=.9*i,o=t+.05*i,r=e+.56*i;S({x:o,y:r,width:a,height:.57*i,radius:.03*i}),W.fillStyle=`rgba(${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, ${Math.floor(255-255*n)}, 0.75)`,W.fill(),W.textAlign="start",W.textBaseline="top",W.font=`900 ${.05*i}px ${window.fontFamily}`,W.fillStyle=`rgba(${Math.floor(255*n)}, ${Math.floor(255*n)}, ${Math.floor(255*n)}, 1)`,T({x:o+.05*i,y:r+.05*i,width:a-.12*i,fontHeight:.075*i,text:h.description(h.level)})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05)),this.mouseDownPosition&&this.mouseDownPositionTime<1&&(this.mouseDownPositionTime=w(this.mouseDownPositionTime+.05)),!this.mouseDownPosition&&this.mouseDownPositionTime>0&&(this.mouseDownPositionTime=w(this.mouseDownPositionTime-.05)),this.ifTouchEnd&&this.ifTouchEndTime<1&&(this.ifTouchEndTime=w(this.ifTouchEndTime+.05)),!this.ifTouchEnd&&this.ifTouchEndTime>0&&(this.ifTouchEndTime=w(this.ifTouchEndTime-.05)),this.useAble&&this.useAbleTime<1&&(this.useAbleTime=w(this.useAbleTime+.05)),!this.useAble&&this.useAbleTime>0&&(this.useAbleTime=w(this.useAbleTime-.05));const t=this.card,{x:e,y:i,width:s,height:n}=this.option;W.save(),W.globalAlpha=Math.min(this.novaTime,this.useAbleTime),S({x:e,y:i,width:s,height:n,radius:.08*s}),W.clip(),I(t.imageDOM,{x:e,y:i,width:s,height:n}),this.drawTitle(),this.drawName(),0!==this.mouseDownPositionTime&&(W.globalAlpha=this.mouseDownPositionTime,this.drawRace(),this.drawType(),this.drawDescription()),W.restore(),this.useAble&&(g("touchstart",this.eventDown.bind(this),{x:e,y:i,width:s,height:n}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this)))}}class it{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.type=t.type,this.information=t.information,this.env=t.env,this.useCard=t.useCard,this.InstanceCards=[],this.touchCard,this.show="card"}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawBackground(){const{x:t,y:e,width:i,height:s,information:n}=this;W.save(),S({x:t,y:e,width:i,height:s,radius:this.width/2}),W.clip(),I(n.master.imageDOM,{x:t,y:e,width:i,height:s}),W.restore()}drawTitle(){W.save();const{x:t,y:e,width:i,height:s,information:n}=this,h={width:.4*i,height:.12*i};h.x=t+i/2-h.width/2,h.y=e+.02*i,h.radius=h.height/4,h.text=[n.master.name,c(n.master.level)].join(" "),h.font=`900 ${.04*i}px ${window.fontFamily}`,h.fillStyle=["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],new E(h).render(),W.restore()}drawHM(){const{x:t,y:e,width:i,height:s,information:n}=this,h={width:Math.min(.7*i,J/2-24),height:.12*i};h.y=e+s-h.height-.02*i,h.radius=h.height/2,h.x=t+i/2-h.width-.02*i,S(h),W.textAlign="center",W.textBaseline="middle",W.font=`900 ${.04*i}px ${window.fontFamily}`,W.fillStyle="rgba(185, 0, 0, 1)",W.fill(),W.fillStyle="rgba(255, 255, 255, 1)",W.fillText(`HP ${n.master.HP}`,h.x+h.width/2,h.y+h.height/2),h.x=t+i/2+.02*i,S(h),W.fillStyle="rgba(0, 0, 185, 1)",W.fill(),W.fillStyle="rgba(255, 255, 255, 1)",W.fillText(`MP ${n.master.MP}`,h.x+h.width/2,h.y+h.height/2)}drawBuff(){const{x:t,y:e,width:i,height:s,information:n}=this;W.textAlign="center",W.textBaseline="middle",W.fillStyle="rgba(0, 0, 0, 1)",W.font=`900 ${.03*i}px ${window.fontFamily}`;var h=n.master.buff.reduce(((t,e)=>{const i=t.find((t=>t.name===e));return i&&(i.number=i.number+1),i||t.push({name:e,number:1}),t}),[{name:"BUFF"}]);h.forEach(((s,n)=>{const a={width:.16*i,height:.08*i,y:e+.15*i},o=n-(h.length/2-.5);a.radius=a.height/4,a.x=t+(i-a.width)/2+o*(a.width+.02*i),S(a),W.fillStyle="rgba(0, 0, 0, 0.75)",W.fill(),W.fillStyle="rgba(255, 255, 255, 1)",W.fillText(s.number?`${s.name} X${s.number}`:s.name,a.x+a.width/2,a.y+a.height/2)}))}drawCard(){const t=Math.min(1.75*this.width,J-24),e=this.height,i=this.x-(t-this.width)/2,s=this.y+.02*t;this.InstanceCards=this.InstanceCards.filter((t=>this.information.card.hand.find((e=>e===t.card)))),this.information.card.hand.forEach(((n,h)=>{const a=h-(this.information.card.hand.length/2-.5),o={width:t/4-4-t/48};o.height=1.35*o.width,o.x=i+(t-o.width)/2+a*(t/4-4),o.y=s+(e-o.height)/2,o.touchStart=()=>this.touchCard=n,o.touchEnd=()=>this.useCard(n,this),o.useAble=this.env.current===this;const r=this.InstanceCards.find((t=>t.card===n));if(r&&(r.x=o.x,r.useAble=o.useAble),!r){const t="self"===this.type?et:tt;this.InstanceCards.push(new t({card:n,...o}))}})),this.InstanceCards.forEach((t=>t.card!==this.touchCard?t.render():null)),this.InstanceCards.forEach((t=>t.card===this.touchCard?t.render():null))}render(){this.drawBackground(),this.drawTitle(),this.drawHM(),this.drawBuff(),this.drawCard()}}class st{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.InstanceRoleSelf=t.InstanceRoleSelf,this.InstanceRoleOpposite=t.InstanceRoleOpposite,this.env=t.env,this.roundOver=t.roundOver,this.watchStore=t.watchStore,this.watchCemetery=t.watchCemetery,this.useAbleTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawEnv(){const t={x:this.x+12,y:this.y+this.height/2-15+32,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`ROUND ${this.env.round}`};new E(t).render()}drawButtonOverRound(){const t={x:this.x+this.width-84,y:this.y+this.height/2-15+32,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"结束回合"};new E(t).render(),1===this.useAbleTime&&g("touchstart",(()=>{this.roundOver()}),t)}drawButtonStore(){const t={x:this.x+12,y:this.y+this.height/2-15-32,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`查看牌库x${this.InstanceRoleSelf.information.card.store.length}`};new E(t).render(),1===this.useAbleTime&&g("touchstart",(()=>{this.watchStore()}),t)}drawButtonCemetery(){const t={x:this.x+96,y:this.y+this.height/2-15-32,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`查看墓地x${this.InstanceRoleSelf.information.card.cemetery.length}`};new E(t).render(),1===this.useAbleTime&&g("touchstart",(()=>{this.watchCemetery()}),t)}drawBackground(){S({...this.option,radius:12,x:12,width:J-24}),W.fillStyle="rgba(255, 255, 255, 0.5)",W.fill()}render(){this.env.current===this.InstanceRoleSelf&&this.useAbleTime<1&&(this.useAbleTime=w(this.useAbleTime+.05)),this.env.current!==this.InstanceRoleSelf&&this.useAbleTime>0&&(this.useAbleTime=w(this.useAbleTime-.05)),this.drawBackground(),this.drawEnv(),this.drawButtonOverRound(),this.drawButtonStore(),this.drawButtonCemetery()}}const nt=class{constructor(){this.modal=null,this.env={round:0,current:null},this.InstanceRoleSelf,this.InstanceRoleOpposite,this.InstanceAction,this.InstanceModal,this.instanceRoleSelf(),this.instanceRoleOpposite(),this.instanceAction(),this.instanceModal(),this.initBattler()}initBattler(){new Array(3).fill().forEach((t=>{this.pumpCard(this.InstanceRoleSelf.information.card.store.shift(),this.InstanceRoleSelf),this.pumpCard(this.InstanceRoleOpposite.information.card.store.shift(),this.InstanceRoleOpposite)})),this.env.current=this.InstanceRoleSelf,this.roundStart()}instanceRoleSelf(){const t=(z-180-q)/2,e={width:Math.min(J-24,t-24,.3*z),height:Math.min(J-24,t-24,.3*z),type:"self",information:Imitation.state.battle.self,env:this.env,useCard:this.useCard};e.x=(J-e.width)/2,e.y=q+60+(z-180-q)/2+120+(t-e.height)/2,this.InstanceRoleSelf=new it(e)}instanceRoleOpposite(){const t=(z-180-q)/2,e={width:Math.min(J-24,t-24,.3*z),height:Math.min(J-24,t-24,.3*z),type:"opposite",information:Imitation.state.battle.opposite,env:this.env,useCard:this.useCard};e.x=(J-e.width)/2,e.y=q+60+(z-180-q)/2-e.height-(t-e.height)/2,this.InstanceRoleOpposite=new it(e)}instanceAction(){const t=J-24;this.InstanceAction=new st({x:(J-t)/2,y:q+60+(z-180-q)/2,width:t,height:120,env:this.env,InstanceRoleSelf:this.InstanceRoleSelf,InstanceRoleOpposite:this.InstanceRoleOpposite,roundOver:this.roundOver,watchStore:()=>{this.modal=!0,this.InstanceModal.title="牌库",this.InstanceModal.card=this.InstanceRoleSelf.information.card.store,this.InstanceModal.init()},watchCemetery:()=>{this.modal=!0,this.InstanceModal.title="墓地",this.InstanceModal.card=this.InstanceRoleSelf.information.card.cemetery,this.InstanceModal.init()}})}instanceModal(){this.InstanceModal=new Z({back:()=>this.modal=!1})}drawRoleSelf(){this.InstanceRoleSelf.render()}drawRoleOpposite(){this.InstanceRoleOpposite.render()}drawAction(){this.InstanceAction.render()}drawModal(){this.InstanceModal.render()}drawBackground(){I(V,{x:0,y:0,width:J,height:z})}drawButtonHome(){const t={x:12,y:12+q,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="explore"}),t)}pumpCard=(t,e)=>{4===e.information.card.hand.length&&e.information.card.cemetery.push(t),e.information.card.hand.length<4&&e.information.card.hand.push(t)};useCard=async(t,e)=>{const[i,s]=e===this.InstanceRoleSelf?[this.InstanceRoleSelf,this.InstanceRoleOpposite]:[this.InstanceRoleOpposite,this.InstanceRoleSelf];var n=t.function(t,i.information,s.information,this.env);if(n.find((t=>t.error)))Imitation.state.function.message(n.find((t=>t.error)).error,"rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)");else{if(Imitation.state.function.message(t.name+" "+c(t.level),"rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),n.find((t=>t.animation))){const t=n.filter((t=>t.animation));for(;t.length;){const e=t.shift();"self"===e.target&&Imitation.state.function.animation(e.animation,(t=>[i.x+i.width/2-t.width/2,i.y+i.height/2-t.height/2])),"opposite"===e.target&&Imitation.state.function.animation(e.animation,(t=>[s.x+s.width/2-t.width/2,s.y+s.height/2-t.height/2]))}}for(i.information.master.skill.forEach((e=>{e.function(t,n,i.information,s.information,this.env)})),i.information.card.hand=i.information.card.hand.filter((e=>e!==t)),i.information.card.cemetery.push(t),i.information.card.consume.push(t);n.length;){const t=n.shift();if("cost-mp"===t.effect&&"self"===t.target&&(i.information.master.MP=i.information.master.MP-t.value),"hit"===t.effect&&"opposite"===t.target&&(s.information.master.HP=s.information.master.HP-t.value),"buff"===t.effect&&("self"===t.target&&i.information.master.buff.push(...new Array(t.number).fill(t.value)),"opposite"===t.target&&s.information.master.buff.push(...new Array(t.number).fill(t.value))),"cost-buff"===t.effect){let e=0;"self"===t.target&&(i.information.master.buff=i.information.master.buff.filter((i=>i!==t.value||e===t.number||(e+=1,!1)))),"opposite"===t.target&&(s.information.master.buff=s.information.master.buff.filter((i=>i!==t.value||e===t.number||(e+=1,!1))))}"cure-hp"===t.effect&&"self"===t.target&&(i.information.master.HP=i.information.master.HP+t.value),"cure-mp"===t.effect&&"self"===t.target&&(i.information.master.MP=i.information.master.MP+t.value),"pump-store-positive"===t.effect&&"self"===t.target&&new Array(t.value).fill().forEach((t=>{const e=this.InstanceRoleSelf.information.card.store.shift();e&&this.pumpCard(e,this.InstanceRoleSelf)})),"pump-store-point"===t.effect&&"self"===t.target&&t.value.forEach((t=>{this.pumpCard(t,this.InstanceRoleSelf),this.InstanceRoleSelf.information.card.store=this.InstanceRoleSelf.information.card.store.filter((e=>e!==t))})),"pump-cemetery-positive"===t.effect&&"self"===t.target&&new Array(t.value).fill().forEach((t=>{this.pumpCard(this.InstanceRoleSelf.information.card.cemetery.shift(),this.InstanceRoleSelf)})),"pump-cemetery-point"===t.effect&&"self"===t.target&&t.value.forEach((t=>{this.pumpCard(t,this.InstanceRoleSelf),this.InstanceRoleSelf.information.card.cemetery=this.InstanceRoleSelf.information.card.cemetery.filter((e=>e!==t))}))}this.battlerOver()}};roundStart=async()=>{if(new Array(1).fill().forEach((t=>{const e=this.env.current.information.card.store.shift();e&&this.pumpCard(e,this.env.current)})),this.env.current===this.InstanceRoleSelf&&(this.env.round=this.env.round+1),this.env.current===this.InstanceRoleOpposite){const t=this.InstanceRoleOpposite.information.AI(this.InstanceRoleOpposite.information,this.InstanceRoleSelf.information,this.env);for(;t.length;)await f(750),await this.useCard(t.shift(),this.InstanceRoleOpposite),await f(750);this.roundOver()}};roundOver=async()=>this.env.current===this.InstanceRoleSelf?(this.env.current=this.InstanceRoleOpposite,void await this.roundStart()):this.env.current===this.InstanceRoleOpposite?(this.env.current=this.InstanceRoleSelf,void await this.roundStart()):void 0;battlerOver=()=>{if(this.InstanceRoleOpposite.information.master.HP<=0){const t=Imitation.state.battle.reward(),e=Imitation.state.info.library.card.reward.forEach((t=>{if(t.money){const e=Imitation.state.info.money.find((t=>t.key==t.key));e.number=e.number+t.number}if(t.card){const i=e.find((e=>e.key===t.key));i&&(i.number=i.number+t.number),i||e.push({key:t.key,level:t.level,number:t.number})}if(t.master){const i=e.master.find((e=>e.key===t.key));i&&(i.exp=i.exp+t.number/Math.pow(2,i.level-1),i.exp>100&&(i.level=i.level+1,i.exp=.5*(i.exp-100))),i||e.push({key:t.key,level:1,exp:t.number})}}));return Imitation.state.function.saveInfo(),Imitation.state.function.message("战斗胜利","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.reward={value:t,back:"explore",title:"战斗胜利"},Imitation.state.page.current="transition",void(Imitation.state.page.next="reward")}if(this.InstanceRoleSelf.information.master.HP<=0)return Imitation.state.function.message("战斗失败","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.reward={value:[],back:"explore",title:"战斗失败"},Imitation.state.page.current="transition",void(Imitation.state.page.next="reward")};render(){this.drawBackground(),this.modal&&this.drawModal(),this.modal||(this.drawButtonHome(),this.drawAction(),this.drawRoleOpposite(),this.drawRoleSelf())}},ht=canvas.getContext("2d"),at=v(Y),ot=wx.getSystemInfoSync().safeArea.top,rt=wx.getSystemInfoSync().windowWidth,lt=wx.getSystemInfoSync().windowHeight;class dt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.card=t.card,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText("CARD 卡牌",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i,l=.03*i,d=[n.name,c(n.level)];n.number&&d.push("x"+n.number),S({x:o,y:r,width:h,height:a,radius:l}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText(d.join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card;ht.save(),S({x:t,y:e,width:i,height:s,radius:8}),ht.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),ht.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}class ct{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.card=t.card,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText("CARD 卡牌",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i,l=.03*i,d=[n.name,c(n.level)];n.number&&d.push("x"+n.number),S({x:o,y:r,width:h,height:a,radius:l}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText(d.join(" "),o+h/2,r+a/2)}drawRace(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=.12*i,o=t+.05*i,r=e+.22*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText(n.race,o+h/2,r+a/2)}drawType(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=.12*i,o=t+.05*i,r=e+.39*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText(n.type,o+h/2,r+a/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=t+.05*i,o=e+.56*i;S({x:a,y:o,width:h,height:.57*i,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="start",ht.textBaseline="top",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",T({x:a+.05*i,y:o+.05*i,width:h-.12*i,fontHeight:.075*i,text:n.description(n.level)})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const{x:t,y:e,width:i,height:s}=this.option,n=this.card;ht.save(),S({x:t,y:e,width:i,height:s,radius:.08*i}),ht.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),this.drawRace(),this.drawType(),this.drawDescription(),ht.restore()}}class ft{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.master=t.master,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=(this.master,.35*i),h=.07*i,a=t+.03*i,o=e+.03*i;S({x:a,y:o,width:n,height:h,radius:.02*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.025*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText("MASTER 队长",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.35*i,a=.07*i,o=t+i-h-.03*i,r=e+s-a-.03*i;S({x:o,y:r,width:h,height:a,radius:.02*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.025*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText([n.name,c(n.level)].join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master;ht.save(),S({x:t,y:e,width:i,height:s,radius:12}),ht.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),ht.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}class wt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.master=t.master,this.skillIndex=0,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText("MASTER 队长",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText([n.name,c(n.level),`${n.exp}%`].join(" "),o+h/2,r+a/2)}drawHP(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.9*i,a=.12*i,o=t+.05*i,r=e+.22*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText("HP "+n.HP,o+h/2,r+a/2)}drawMP(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.9*i,a=.12*i,o=t+.05*i,r=e+.39*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="center",ht.textBaseline="middle",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",ht.fillText("MP "+n.MP,o+h/2,r+a/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.9*i,a=t+.05*i,o=e+.56*i;S({x:a,y:o,width:h,height:.57*i,radius:.03*i}),ht.fillStyle="rgba(255, 255, 255, 0.75)",ht.fill(),ht.textAlign="start",ht.textBaseline="top",ht.font=`900 ${.05*i}px ${window.fontFamily}`,ht.fillStyle="rgba(0, 0, 0, 1)",T({x:a+.05*i,y:o+.05*i,width:h-.12*i,fontHeight:.075*i,text:n.skill[this.skillIndex].description(n.level)})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const{x:t,y:e,width:i,height:s}=this.option,n=this.master;ht.save(),S({x:t,y:e,width:i,height:s,radius:.08*i}),ht.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),this.drawHP(),this.drawMP(),this.drawDescription(),ht.restore()}}const mt=class{constructor(){this.preview=null,this.type="team",this.sort="name",this.master,this.card,this.InstanceScroll,this.InstanceMasterList,this.InstanceMasterPreview,this.InstanceCardList,this.InstanceCardPreview,this.init()}get bannerHeight(){return 138}get masterHeight(){const t=this.master.length;return 0===t?-12:(rt-60)/4*1.35*t+(t?12*(t-1):0)}get cardHeight(){const t=Math.ceil(this.card.length/4);return 0===t?0:(rt-60)/4*1.35*t+(t?12*(t-1):0)}init(){this.master=[],this.card=[],"team"===this.type&&(this.master=l([Imitation.state.info.library.master.find((t=>t.key===Imitation.state.info.team[Imitation.state.info.teamIndex].master[0].key))]),this.card=r(Imitation.state.info.team[Imitation.state.info.teamIndex].card,!0),this.card=this.card.sort(((t,e)=>{const i=String(t[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0);return String(e[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0)-i}))),"library-card"===this.type&&(this.card=r(Imitation.state.info.library.card),this.card=this.card.sort(((t,e)=>{const i=String(t[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0);return String(e[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0)-i}))),"library-master"===this.type&&(this.master=l(Imitation.state.info.library.master)),this.instanceScroll(),this.instanceMasterList(),this.instanceCardList(),this.instanceCardPreview(),this.instanceMasterPreview()}instanceScroll(){const t={x:12,y:60+ot,width:rt-24,height:lt-72-ot,radius:12};t.scrollY=this.bannerHeight+this.masterHeight+this.cardHeight-t.height+24,this.InstanceScroll=new O(t)}instanceMasterList(){this.InstanceMasterList=this.master.map(((t,e)=>{const i={width:rt-24,master:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=(rt-60)/4*1.35,i.x=12,i.y=72+e*(i.height+12)+this.bannerHeight+ot,new ft(i)}))}instanceCardList(){this.InstanceCardList=this.card.map(((t,e)=>{const i={width:(rt-60)/4,card:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=1.35*i.width,i.x=12+parseInt(e%4)*(i.width+12),i.y=84+parseInt(e/4)*(i.height+12)+this.bannerHeight+this.masterHeight+ot,new dt(i)}))}instanceCardPreview(){const t={};t.width=.7*rt,t.height=1.35*t.width,t.x=.15*rt,t.y=(lt-1.5*t.width)/2-60,this.InstanceCardPreview=new ct(t)}instanceMasterPreview(){const t={};t.width=.7*rt,t.height=1.35*t.width,t.x=.15*rt,t.y=(lt-1.5*t.width)/2-60,this.InstanceMasterPreview=new wt(t)}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawBanner(e),this.drawMaster(e),this.drawCard(e)}))}drawBanner(t){const e={x:12,y:60-t+ot,width:rt-24,height:this.bannerHeight,radius:12};x(e,this.InstanceScroll.option)&&(ht.save(),S(e),ht.fillStyle="rgba(0, 0, 0, 0.25)",ht.fill(),ht.clip(),new Array(Imitation.state.info.team.length).fill().forEach(((t,i)=>{const s={x:24+72*i,y:12+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:i===Imitation.state.info.teamIndex?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`队伍 ${i+1}`};x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(t=>{p(t,this.InstanceScroll.option)&&(Imitation.state.info.teamIndex=i,this.type="team",this.init())}),s))})),new Array(["name","名称"],["level","等级"],["type","类型"],["race","种类"]).forEach(((t,i)=>{const s={x:24+72*i,y:54+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:t[0]===this.sort?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:t[1]};x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.sort=t[0],this.init())}),s))})),new Array(["team","队伍"],["library-card","卡牌仓库"],["library-master","队长仓库"]).forEach(((t,i)=>{const s={x:24+72*i,y:96+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:t[0]===this.type?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:t[1]};x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.type=t[0],this.init())}),s))})),ht.restore())}drawCard(t){this.InstanceCardList.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawMaster(t){this.InstanceMasterList.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawPreview(){var t=[];const e=this.InstanceMasterPreview.y+this.InstanceMasterPreview.height;if("team"===this.type){if(this.InstanceCardList.find((t=>t.card===this.preview))){this.InstanceCardPreview.card=this.preview,this.InstanceCardPreview.render();const i={x:rt/2-60,y:e+40,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"卸载"};new E(i).render(),g("touchstart",(()=>{this.unloadCard(this.preview),this.preview=null,this.InstanceCardPreview.novaTime=0}),i),t.push(i)}this.InstanceMasterList.find((t=>t.master===this.preview))&&(this.InstanceMasterPreview.master=this.preview,this.InstanceMasterPreview.render(),this.preview.skill.forEach(((i,s)=>{const n={x:rt/2-40,y:e+20,width:80,height:32,radius:8,font:`900 10px ${window.fontFamily}`,text:i.name};n.fillStyle=s===this.InstanceMasterPreview.skillIndex?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"];const h=this.preview.skill.length,a=(s-(h/2-.5))*n.width*1.1;n.x=n.x+a,new E(n).render(),g("touchstart",(t=>{this.InstanceMasterPreview.skillIndex=s}),n),t.push(n)})))}if("library-card"===this.type){this.InstanceCardPreview.card=this.preview,this.InstanceCardPreview.render();const i={x:rt/2-60,y:e+40,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"装载"};new E(i).render(),g("touchstart",(()=>{this.loadCard(this.preview),this.preview=null,this.InstanceCardPreview.novaTime=0}),i),t.push(i);const s={x:rt/2-60,y:e+100,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"合成"};new E(s).render(),g("touchstart",(()=>{this.composeCard(this.preview),this.preview=null,this.InstanceCardPreview.novaTime=0}),s),t.push(s)}if("library-master"===this.type){this.InstanceMasterPreview.master=this.preview,this.InstanceMasterPreview.render(),this.preview.skill.forEach(((i,s)=>{const n={x:rt/2-40,y:e+20,width:80,height:32,radius:8,font:`900 10px ${window.fontFamily}`,text:i.name};n.fillStyle=s===this.InstanceMasterPreview.skillIndex?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"];const h=this.preview.skill.length,a=(s-(h/2-.5))*n.width*1.1;n.x=n.x+a,new E(n).render(),g("touchstart",(t=>{this.InstanceMasterPreview.skillIndex=s}),n),t.push(n)}));const i={x:rt/2-60,y:e+80,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"装载"};new E(i).render(),g("touchstart",(()=>{this.loadMaster(this.preview),this.preview=null,this.InstanceMasterPreview.novaTime=0}),i),t.push(i)}y("touchstart",(e=>{t.some((t=>p(e,t)))||(this.preview=null,this.InstanceMasterPreview.skillIndex=0,this.InstanceMasterPreview.novaTime=0,this.InstanceCardPreview.novaTime=0)}))}drawButtonHome(){const t={x:12,y:12+ot,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}composeCard(t){const e=Imitation.state.info.library.card,i=Imitation.state.info.team[Imitation.state.info.teamIndex].card,s=e.find((e=>e.key===t.key&&e.level===t.level)),n=e.find((e=>e.key===t.key&&e.level===t.level+1)),h=i.find((e=>e.key===t.key&&e.level===t.level));if(s.number<3)Imitation.state.function.message("卡牌数量不足","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)");else{if(s.number=s.number-3,0===s.number){const t=e.indexOf(s);e.splice(t,1)}if(n&&(n.number=n.number+1),n||e.push({key:t.key,level:t.level+1,number:1}),h&&(h.number>s.number&&(h.number=s.number),0===h.number)){const t=i.indexOf(h);i.splice(t,1)}this.init(),Imitation.state.function.message("合成成功","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo()}}loadCard(t){const e=Imitation.state.info.library.card,i=Imitation.state.info.team[Imitation.state.info.teamIndex].card,s=e.find((e=>e.key===t.key&&e.level===t.level)),n=i.find((e=>e.key===t.key&&e.level===t.level));i.reduce(((t,e)=>t+e.number),0)>40?Imitation.state.function.message("超出卡组数量限制","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):i.filter((e=>e.key===t.key)).reduce(((t,e)=>t+e.number),0)>=t.limit?Imitation.state.function.message("超出卡牌数量限制","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):n&&n.number===s.number?Imitation.state.function.message("卡组数量不足","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):(n&&(n.number=n.number+1),n||i.push({key:t.key,level:t.level,number:1}),this.init(),Imitation.state.function.message("装载成功","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo())}unloadCard(t){const e=Imitation.state.info.team[Imitation.state.info.teamIndex].card,i=e.find((e=>e.key===t.key&&e.level===t.level));if(i.number=i.number-1,0===i.number){const t=e.indexOf(i);e.splice(t,1)}this.init(),Imitation.state.function.message("卸载成功","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo()}loadMaster(t){Imitation.state.info.team[Imitation.state.info.teamIndex].master[0].key=t.key,this.init(),Imitation.state.function.message("装载成功","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo()}render(){I(at,{x:0,y:0,width:rt,height:lt}),this.preview&&this.drawPreview(),this.preview||(this.drawButtonHome(),this.drawScroll())}},ut=canvas.getContext("2d"),gt=v(Y),yt=wx.getSystemInfoSync().safeArea.top,pt=wx.getSystemInfoSync().windowWidth,xt=wx.getSystemInfoSync().windowHeight;class vt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.shop=t.shop,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.35*i,h=.07*i,a=t+.03*i,o=e+.03*i;S({x:a,y:o,width:n,height:h,radius:.02*i}),ut.fillStyle="rgba(255, 255, 255, 0.75)",ut.fill(),ut.textAlign="center",ut.textBaseline="middle",ut.font=`900 ${.025*i}px ${window.fontFamily}`,ut.fillStyle="rgba(0, 0, 0, 1)",ut.fillText("SHOP 礼盒",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.shop,h=.35*i,a=.07*i,o=t+i-h-.03*i,r=e+s-a-.03*i;S({x:o,y:r,width:h,height:a,radius:.02*i}),ut.fillStyle="rgba(255, 255, 255, 0.75)",ut.fill(),ut.textAlign="center",ut.textBaseline="middle",ut.font=`900 ${.025*i}px ${window.fontFamily}`,ut.fillStyle="rgba(0, 0, 0, 1)",ut.fillText([n.name,"¥"+n.money.number].join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.shop;ut.save(),S({x:t,y:e,width:i,height:s,radius:12}),ut.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),ut.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}class bt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.shop=t.shop,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),ut.fillStyle="rgba(255, 255, 255, 0.75)",ut.fill(),ut.textAlign="center",ut.textBaseline="middle",ut.font=`900 ${.05*i}px ${window.fontFamily}`,ut.fillStyle="rgba(0, 0, 0, 1)",ut.fillText("SHOP 礼盒",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.shop,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ut.fillStyle="rgba(255, 255, 255, 0.75)",ut.fill(),ut.textAlign="center",ut.textBaseline="middle",ut.font=`900 ${.05*i}px ${window.fontFamily}`,ut.fillStyle="rgba(0, 0, 0, 1)",ut.fillText(n.name,o+h/2,r+a/2)}drawMoney(){const{x:t,y:e,width:i,height:s}=this.option,n=this.shop,h=.9*i,a=.12*i,o=t+.05*i,r=e+.22*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),ut.fillStyle="rgba(255, 255, 255, 0.75)",ut.fill(),ut.textAlign="center",ut.textBaseline="middle",ut.font=`900 ${.05*i}px ${window.fontFamily}`,ut.fillStyle="rgba(0, 0, 0, 1)",ut.fillText("¥"+n.money.number,o+h/2,r+a/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.shop,h=.9*i,a=t+.05*i,o=e+.56*i;S({x:a,y:o,width:h,height:.57*i,radius:.03*i}),ut.fillStyle="rgba(255, 255, 255, 0.75)",ut.fill(),ut.textAlign="start",ut.textBaseline="top",ut.font=`900 ${.05*i}px ${window.fontFamily}`,ut.fillStyle="rgba(0, 0, 0, 1)",T({x:a+.05*i,y:o+.05*i,width:h-.12*i,fontHeight:.075*i,text:n.description})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const{x:t,y:e,width:i,height:s}=this.option,n=this.shop;ut.save(),S({x:t,y:e,width:i,height:s,radius:.08*i}),ut.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),this.drawMoney(),this.drawDescription(),ut.restore()}}const It=class{constructor(){this.preview=null,this.money=1,this.type="alltime",this.shop,this.InstanceScroll,this.InstanceShop,this.InstanceShopPreview,this.init()}get bannerHeight(){return 96}get shopHeight(){const t=this.shop.length;return 0===t?-12:(pt-60)/4*1.35*t+(t?12*(t-1):0)}init(){this.shop=Imitation.state.shop.filter((t=>t.type===this.type&&t.money.key===this.money)),this.instanceScroll(),this.instanceShop(),this.instanceShopPreview()}instanceScroll(){const t={x:12,y:60+yt,width:pt-24,height:xt-72-yt,radius:12};t.scrollY=this.bannerHeight+this.shopHeight-t.height+24,this.InstanceScroll=new O(t)}instanceShop(){this.InstanceShop=this.shop.map(((t,e)=>{const i={width:pt-24,shop:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=(pt-60)/4*1.35,i.x=12,i.y=72+e*(i.height+12)+this.bannerHeight+yt,new vt(i)}))}instanceShopPreview(){const t={width:.7*pt,shop:this.preview};t.height=1.35*t.width,t.x=.15*pt,t.y=(xt-1.5*t.width)/2-60,this.InstanceShopPreview=new bt(t)}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawBanner(e),this.drawShop(e)}))}drawBanner(t){const e={x:12,y:60-t+yt,width:pt-24,height:this.bannerHeight,radius:12};x(e,this.InstanceScroll.option)&&(ut.save(),S(e),ut.fillStyle="rgba(0, 0, 0, 0.25)",ut.fill(),ut.clip(),d(Imitation.state.info.money).forEach(((t,i)=>{const s={x:24+84*i,y:12+e.y,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,text:t.name};s.fillStyle=t.key===this.money?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.money=t.key,this.init())}),s))})),[["alltime","常驻"],["week_"+(new Date).getDay(),"周活动"]].forEach(((t,i)=>{const s={x:24+84*i,y:54+e.y,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,text:t[1]};s.fillStyle=t[0]===this.type?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.type=t[0],this.init())}),s))})),ut.restore())}drawShop(t){this.InstanceShop.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawPreview(){var t=[];const e=this.InstanceShopPreview.y+this.InstanceShopPreview.height;this.InstanceShopPreview.shop=this.preview,this.InstanceShopPreview.render();const i={x:pt/2-60,y:e+40,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"购买"};new E(i).render(),g("touchstart",(()=>{this.buy(this.preview),this.preview=null,this.InstanceShopPreview.novaTime=0}),i),t.push(i),y("touchstart",(e=>{t.some((t=>p(e,t)))||(this.preview=null,this.InstanceShopPreview.novaTime=0)}))}drawButtonHome(){const t={x:12,y:12+yt,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}drawInfo(){const t=d(Imitation.state.info.money);t.forEach(((e,i)=>{const s=i-(t.length/2-.5),n={y:xt-48,width:84,height:32,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"],text:`${e.name} ${e.number}`};n.x=(pt-n.width)/2+s*(n.width+8),new E(n).render()}))}buy(t){const e=Imitation.state.info.money.find((e=>e.key===t.money.key));if(e.number<t.money.number)return void Imitation.state.function.message("货币不足","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)");e.number=e.number-t.money.number;const i=Imitation.state.info.library,s=t.reward();s.forEach((t=>{if(t.card){const e=i.card.find((e=>e.key===t.key&&e.level===t.level));e&&(e.number=e.number+t.number),e||i.push({key:t.key,level:t.level,number:t.number})}if(t.master){const e=i.master.find((e=>e.key===t.key));e&&(e.exp=e.exp+t.number/Math.pow(2,e.level-1),e.exp>100&&(e.level=e.level+1,e.exp=.5*(e.exp-100))),e||i.push({key:t.key,level:1,exp:t.number})}})),Imitation.state.function.message("购买成功","rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo(),Imitation.state.reward={value:s,back:"shop",title:"购买获得"},Imitation.state.page.current="transition",Imitation.state.page.next="reward"}render(){I(gt,{x:0,y:0,width:pt,height:xt}),this.preview||(this.drawButtonHome(),this.drawScroll(),this.drawInfo()),this.preview&&(this.drawPreview(),this.drawInfo())}},St=canvas.getContext("2d"),Tt=v(Y),Mt=wx.getSystemInfoSync().safeArea.top,At=wx.getSystemInfoSync().windowWidth,$t=wx.getSystemInfoSync().windowHeight;class Pt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.money=t.money}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=(this.money,.35*i),h=.07*i,a=t+.03*i,o=e+.03*i;S({x:a,y:o,width:n,height:h,radius:.02*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.025*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("MONEY 货币",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.money,h=.35*i,a=.07*i,o=t+i-h-.03*i,r=e+s-a-.03*i;S({x:o,y:r,width:h,height:a,radius:.02*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.025*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText([n.name,n.number].join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.money;St.save(),S({x:t,y:e,width:i,height:s,radius:12}),St.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),St.restore()}}class kt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.card=t.card,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("CARD 卡牌",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i,l=.03*i,d=[n.name,c(n.level)];n.number&&d.push("x"+n.number),S({x:o,y:r,width:h,height:a,radius:l}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText(d.join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card;St.save(),S({x:t,y:e,width:i,height:s,radius:8}),St.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),St.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}class Ct{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.card=t.card,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("CARD 卡牌",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i,l=.03*i,d=[n.name,c(n.level)];n.number&&d.push("x"+n.number),S({x:o,y:r,width:h,height:a,radius:l}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText(d.join(" "),o+h/2,r+a/2)}drawRace(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=.12*i,o=t+.05*i,r=e+.22*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText(n.race,o+h/2,r+a/2)}drawType(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=.12*i,o=t+.05*i,r=e+.39*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText(n.type,o+h/2,r+a/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.card,h=.9*i,a=t+.05*i,o=e+.56*i;S({x:a,y:o,width:h,height:.57*i,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="start",St.textBaseline="top",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",T({x:a+.05*i,y:o+.05*i,width:h-.12*i,fontHeight:.075*i,text:n.description(n.level)})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const{x:t,y:e,width:i,height:s}=this.option,n=this.card;St.save(),S({x:t,y:e,width:i,height:s,radius:.08*i}),St.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),this.drawRace(),this.drawType(),this.drawDescription(),St.restore()}}class Et{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.master=t.master,this.touchEvent=t.touchEvent,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x+this.offsetX,y:this.y+this.offsetY,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!p(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=(this.master,.35*i),h=.07*i,a=t+.03*i,o=e+.03*i;S({x:a,y:o,width:n,height:h,radius:.02*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.025*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("MASTER 队长",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.35*i,a=.07*i,o=t+i-h-.03*i,r=e+s-a-.03*i;S({x:o,y:r,width:h,height:a,radius:.02*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.025*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText([n.name,c(n.level)].join(" "),o+h/2,r+a/2)}render(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master;St.save(),S({x:t,y:e,width:i,height:s,radius:12}),St.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),St.restore(),g("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),y("touchmove",this.eventMove.bind(this)),y("touchend",this.eventUp.bind(this))}}class Dt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.master=t.master,this.skillIndex=0,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawTitle(){const{x:t,y:e,width:i,height:s}=this.option,n=.5*i,h=.12*i,a=t+.05*i,o=e+.05*i;S({x:a,y:o,width:n,height:h,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("MASTER 队长",a+n/2,o+h/2)}drawName(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.5*i,a=.12*i,o=t+i-h-.05*i,r=e+s-a-.05*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText([n.name,n.number].join(" "),o+h/2,r+a/2)}drawHP(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.9*i,a=.12*i,o=t+.05*i,r=e+.22*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("HP "+n.HP,o+h/2,r+a/2)}drawMP(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.9*i,a=.12*i,o=t+.05*i,r=e+.39*i;S({x:o,y:r,width:h,height:a,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="center",St.textBaseline="middle",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",St.fillText("MP "+n.MP,o+h/2,r+a/2)}drawDescription(){const{x:t,y:e,width:i,height:s}=this.option,n=this.master,h=.9*i,a=t+.05*i,o=e+.56*i;S({x:a,y:o,width:h,height:.57*i,radius:.03*i}),St.fillStyle="rgba(255, 255, 255, 0.75)",St.fill(),St.textAlign="start",St.textBaseline="top",St.font=`900 ${.05*i}px ${window.fontFamily}`,St.fillStyle="rgba(0, 0, 0, 1)",T({x:a+.05*i,y:o+.05*i,width:h-.12*i,fontHeight:.075*i,text:n.skill[this.skillIndex].description(n.level)})}render(){this.novaTime<1&&(this.novaTime=w(this.novaTime+.05));const{x:t,y:e,width:i,height:s}=this.option,n=this.master;St.save(),S({x:t,y:e,width:i,height:s,radius:.08*i}),St.clip(),I(n.imageDOM,{x:t,y:e,width:i,height:s}),this.drawTitle(),this.drawName(),this.drawHP(),this.drawMP(),this.drawDescription(),St.restore()}}const Bt=class{constructor(){this.preview=null,this.type="card",this.card=[],this.master=[],this.money=[],this.InstanceScroll,this.InstanceCard,this.InstanceCardPreview,this.InstanceMaster,this.InstanceMasterPreview,this.InstanceMoney,this.init()}get bannerHeight(){return 96}get masterHeight(){const t=this.master.length;return 0===t?0:(At-60)/4*1.35*t+(t?12*(t-1):0)}get cardHeight(){const t=Math.ceil(this.card.length/4);return 0===t?0:(At-60)/4*1.35*t+(t?12*(t-1):0)}get moneyHeight(){const t=Math.ceil(this.money.length/4);return 0===t?0:(At-60)/4*1.35*t+(t?12*(t-1):0)}init(){this.card=[],this.master=[],this.money=[],"card"===this.type&&(this.card=r(Imitation.state.reward.value.filter((t=>t.card)),!0)),"master"===this.type&&(this.master=l(Imitation.state.reward.value.filter((t=>t.master)).map((t=>({...t,level:1}))))),"money"===this.type&&(this.money=d(Imitation.state.reward.value.filter((t=>t.money)))),this.instanceScroll(),this.instanceCard(),this.instanceMaster(),this.instanceMoney(),this.instanceCardPreview(),this.instanceMasterPreview()}instanceScroll(){const t={x:12,y:60+Mt,width:At-24,height:$t-72-Mt,radius:12};t.scrollY=this.bannerHeight+this.masterHeight+this.cardHeight+this.moneyHeight-t.height+12,this.InstanceScroll=new O(t)}instanceMaster(){this.InstanceMaster=this.master.map(((t,e)=>{const i={width:At-24,master:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=(At-60)/4*1.35,i.x=12,i.y=72+e*(i.height+12)+this.bannerHeight+Mt,new Et(i)}))}instanceCard(){this.InstanceCard=this.card.map(((t,e)=>{const i={width:(At-60)/4,card:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=1.35*i.width,i.x=12+parseInt(e%4)*(i.width+12),i.y=72+parseInt(e/4)*(i.height+12)+this.bannerHeight+Mt,new kt(i)}))}instanceMoney(){this.InstanceMoney=this.money.map(((t,e)=>{const i={width:At-24,money:t};return i.height=(At-60)/4*1.35,i.x=12,i.y=72+e*(i.height+12)+this.bannerHeight+Mt,new Pt(i)}))}instanceCardPreview(){const t={width:.7*At,card:this.preview};t.height=1.35*t.width,t.x=.15*At,t.y=($t-1.5*t.width)/2-60,this.InstanceCardPreview=new Ct(t)}instanceMasterPreview(){const t={width:.7*At,card:this.preview};t.height=1.35*t.width,t.x=.15*At,t.y=($t-1.5*t.width)/2-60,this.InstanceMasterPreview=new Dt(t)}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawBanner(e),this.drawMaster(e),this.drawCard(e),this.drawMoney(e)}))}drawBanner(t){const e={x:12,y:60-t+Mt,width:At-24,height:this.bannerHeight,radius:12};if(x(e,this.InstanceScroll.option)){St.save(),S(e),St.fillStyle="rgba(0, 0, 0, 0.25)",St.fill(),St.clip();{const t={x:24,y:12+e.y,width:At-48,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"],text:Imitation.state.reward.title};if(!x(t,this.InstanceScroll.option))return;new E(t).render()}new Array(["card","卡牌"],["master","队长"],["money","资源"]).forEach(((t,i)=>{const s={x:24+72*i,y:54+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,text:t[1]};s.fillStyle=t[0]===this.type?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],x(s,this.InstanceScroll.option)&&(new E(s).render(),g("touchstart",(e=>{p(e,this.InstanceScroll.option)&&(this.type=t[0],this.init())}),s))})),St.restore()}}drawCard(t){this.InstanceCard.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawMaster(t){this.InstanceMaster.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawMoney(t){this.InstanceMoney.forEach((e=>{e.offsetY=0-t,x(e.option,this.InstanceScroll.option)&&e.render()}))}drawPreview(){var t=[];const e=this.InstanceMasterPreview.y+this.InstanceMasterPreview.height;this.InstanceCard.find((t=>t.card===this.preview))&&(this.InstanceCardPreview.card=this.preview,this.InstanceCardPreview.render()),this.InstanceMaster.find((t=>t.master===this.preview))&&(this.InstanceMasterPreview.master=this.preview,this.InstanceMasterPreview.render(),this.preview.skill.forEach(((i,s)=>{const n={x:At/2-40,y:e+20,width:80,height:32,radius:8,font:`900 10px ${window.fontFamily}`,text:i.name};n.fillStyle=s===this.InstanceMasterPreview.skillIndex?["rgba(0, 0, 0, 1)","rgba(255, 255, 255, 1)"]:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"];const h=this.preview.skill.length,a=(s-(h/2-.5))*n.width*1.1;n.x=n.x+a,new E(n).render(),g("touchstart",(t=>{this.InstanceMasterPreview.skillIndex=s}),n),t.push(n)}))),y("touchstart",(t=>{this.preview=null,this.InstanceMasterPreview.skillIndex=0,this.InstanceMasterPreview.novaTime=0,this.InstanceCardPreview.novaTime=0}))}drawButtonHome(){const t={x:12,y:12+Mt,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new E(t).render(),g("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next=Imitation.state.reward.back}),t)}render(){I(Tt,{x:0,y:0,width:At,height:$t}),this.preview&&this.drawPreview(),this.preview||(this.drawButtonHome(),this.drawScroll())}},Ft=canvas.getContext("2d"),Ht=(wx.getSystemInfoSync().safeArea.top,wx.getSystemInfoSync().windowWidth),Rt=wx.getSystemInfoSync().windowHeight;class Ot{constructor(){this.message="",this.backgroundColor="rgba(255, 255, 255, 1)",this.textColor="rgba(0, 0, 0, 1)",this.timeout=750,this.timeoutRef=null,this.show=!1,this.opacity=0,this.width=Math.min(Ht-24,180),this.height=32,this.x=(Ht-this.width)/2,this.y=Rt}send(t,e="rgba(255, 255, 255, 1)",i="rgba(0, 0, 0, 1)"){clearTimeout(this.timeoutRef),this.message=t,this.backgroundColor=e,this.textColor=i,this.show=!0,this.timeoutRef=setTimeout((()=>{this.show=!1,this.timeoutRef=null}),this.timeout)}render(){this.show&&this.opacity<1&&(this.opacity=w(this.opacity+.05)),!this.show&&this.opacity>0&&(this.opacity=w(this.opacity-.05)),this.show&&this.y>Rt-44&&(this.y=w(this.y-4)),!this.show&&this.y<Rt&&(this.y=w(this.y+4)),(this.show||0!==this.opacity)&&(Ft.save(),Ft.globalAlpha=this.opacity,Ft.textAlign="center",Ft.textBaseline="middle",Ft.font=`900 10px ${window.fontFamily}`,Ft.fillStyle=this.backgroundColor,S({x:this.x,y:this.y,width:this.width,height:this.height,radius:8}),Ft.fill(),Ft.fillStyle=this.textColor,Ft.fillText(this.message,this.x+this.width/2,this.y+this.height/2),Ft.restore())}}class Yt{constructor(){this.map={},this.audioQueue=new Array(8).fill().map((t=>new Audio))}play(t,e=!1){const i=this.audioQueue.find((t=>!t.playing));i.onended=()=>i.playing=!1,i.playing=!0,i.loop=e,i.src=this.map[t],i.play()}}const Xt="build/0.png",Nt="build/1.png",jt="build/2.png",Lt="build/3.png",Ut="build/4.png",_t="build/5.png",Qt=canvas.getContext("2d");class Wt{constructor(){this.map={"red-hit":[Xt,Xt,Nt,Nt,jt,jt,Lt,Lt,Ut,Ut,_t,_t].map((t=>this.createImage(t)))},this.animationQueue=[]}createImage=t=>{const e=new Image;return e.src=t,e};play(t,e){this.map[t]&&this.animationQueue.push({index:0,imgs:this.map[t],option:e,option:e})}render(){this.animationQueue.forEach(((t,e)=>{const i=t.imgs[t.index];i&&(Qt.drawImage(i,...t.option(i)),t.index=t.index+1),i||this.animationQueue.splice(e,1)}))}}const Vt=canvas.getContext("2d");class qt{constructor(){this.width=300,this.height=450,canvas.width=Math.round(this.width*dpr),canvas.height=Math.round(this.height*dpr),canvas.style.width=this.width+"px",canvas.style.height=this.height+"px",canvas.getContext("2d").scale(dpr,dpr),this.cards=h,this.index=0,this.stop=!1}saveImage(t){const e=document.createElement("a");e.href=canvas.toDataURL(),e.download=t,e.click(),this.index=this.index+1,this.stop=!1}render(){if(!this.cards[this.index])return;const t=this.cards[this.index],e=this.width,i=this.height;S({x:0,y:0,width:e,height:i,radius:.08*e}),Vt.clip(),I(t.imageDOM,{x:0,y:0,width:e,height:i}),Vt.fillStyle="rgba(255, 255, 255, 1)",Vt.textAlign="center",Vt.textBaseline="middle",Vt.font=`900 ${.075*e}px ${window.fontFamily}`,Vt.fillText(t.name,0+e/2,0+.12*e),t.number&&Vt.fillText("X"+t.number,0+e-.12*e,0+.12*e),Vt.textAlign="start",Vt.fillText(`${t.race} · ${t.type}`,0+.08*e,0+.48*e),T({x:0+.08*e,y:0+.6*e,width:e-.25*e,fontHeight:.12*e,text:t.description(1)}),this.stop||(setTimeout((()=>this.saveImage("card-"+t.key)),1e3),this.stop=!0)}}const Jt=canvas.getContext("2d");new class{constructor(){this.loadingInformation=!1,this.animationFrameId,this.instance,this.instanceMessage=new Ot,this.instanceSound=new Yt,this.instanceAnimation=new Wt,this.ImitationInit(),this.loopStart()}render(){Jt.clearRect(0,0,canvas.width,canvas.height),Imitation.state.removeEventListener.forEach((t=>t())),Imitation.state.removeEventListener=[];const t=Imitation.state.page.map[Imitation.state.page.current];this.instance instanceof t||(this.instance=new t),this.instance.render(),this.instanceMessage.render(),this.instanceAnimation.render()}loopStart(){this.animationFrameId=requestAnimationFrame((()=>{this.render(),this.loopStart()}))}loopEnd(){cancelAnimationFrame(this.animationFrameId)}ImitationInit(){Imitation.state={page:{current:"home",next:"",map:{"save-image":qt,transition:k,home:H,explore:Q,"battle-pve":nt,store:mt,shop:It,reward:Bt}},removeEventListener:[],info:null,battle:null,explore:a,shop:o,reward:{value:null,back:null},function:{render:this.render,loopStart:this.loopStart,loopEnd:this.loopEnd,message:(t,e,i)=>this.instanceMessage.send(t,e,i),sound:t=>this.instanceSound.play(t),animation:(t,e)=>this.instanceAnimation.play(t,e),saveInfo:()=>{localStorage.setItem("info",JSON.stringify(Imitation.state.info))}}},localStorage.removeItem("info");const t=localStorage.getItem("info");if(t&&(Imitation.state.info=JSON.parse(t)),!t){const t={library:{master:n.map((t=>({key:t.key,level:1,exp:0}))),card:h.map((t=>({key:t.key,level:1,number:t.limit})))},team:[{master:[{key:1}],card:h.map((t=>({key:t.key,level:1,number:t.limit})))},{master:[{key:1}],card:[]},{master:[{key:1}],card:[]},{master:[{key:1}],card:[]}],teamIndex:0,money:[{key:1,number:1e3},{key:2,number:1e3},{key:3,number:1e3}]};Imitation.state.info=t,Imitation.state.function.saveInfo()}}}})()})();