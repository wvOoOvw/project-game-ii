(()=>{var t={652:()=>{!function(){const t=canvas.width,e=canvas.height;canvas.width=Math.round(2*t),canvas.height=Math.round(2*e),canvas.style.width=t+"px",canvas.style.height=e+"px",window.dpr=2,canvas.getContext("2d").scale(2,2)}()},37:()=>{window.fontFamily="Courier"},293:()=>{!function(){if(window.wx)return;window.wx={getSystemInfoSync:()=>({safeArea:{top:0},windowWidth:document.querySelector("canvas").clientWidth,windowHeight:document.querySelector("canvas").clientHeight})};const t=document.querySelector("body");t.style.padding="0",t.style.margin="auto",t.style.left=0,t.style.right=0,t.style.top=0,t.style.bottom=0,t.style.position="absolute",t.style.width="100%",t.style.height="100%";const e=document.createElement("canvas");e.width=t.clientWidth,e.height=t.clientHeight,e.style.display="block",e.style.touchAction="none",t.appendChild(e),window.canvas=e}()},6:()=>{!function(){const t=Symbol("_Allow");function e(t){this.ImitationINS=t,this.dependentQueue=[],this.monitorQueue=[]}function i(t){this.state=t,this.MonitorINS=new e(this)}e.prototype.dispatch=function(){this.monitorQueue.forEach(((e,i)=>{const s=this.dependentQueue[i],n=this.executeDependent(e.dependent);return n===t||Array.isArray(n)&&Array.isArray(s)&&(a=n,h=s,Array.isArray(a)&&Array.isArray(h)&&(a.length!==h.length||a.filter(((t,e)=>t===h[e])).length!==a.length))||!Array.isArray(n)&&!Array.isArray(s)&n!==s?(this.executeEvent(e.event),void(this.dependentQueue[i]=n)):void(this.dependentQueue[i]=n);var a,h}))},e.prototype.register=function(e,i=t){const s={event:e,dependent:i};return this.monitorQueue.push(s),this.dependentQueue.push(this.executeDependent(i)),()=>{this.monitorQueue.forEach(((t,e)=>{t===s&&(this.monitorQueue=this.monitorQueue.filter(((t,i)=>i!==e)),this.dependentQueue=this.dependentQueue.filter(((t,i)=>i!==e)))}))}},e.prototype.executeEvent=function(t){t(this.ImitationINS.state)},e.prototype.executeDependent=function(t){return"function"==typeof t?t(this.ImitationINS.state):t},i.prototype.setState=function(t){this.state="function"==typeof t?t(this.state):t,this.dispatch()},i.prototype.assignState=function(t){this.state=Object.assign(this.state,"function"==typeof t?t(this.state):t),this.dispatch()},i.prototype.register=function(){return this.MonitorINS.register(...arguments)},i.prototype.dispatch=function(){return this.MonitorINS.dispatch(...arguments)};const s=new i;window.Imitation=s}()}},e={};function i(s){var n=e[s];if(void 0!==n)return n.exports;var a=e[s]={exports:{}};return t[s](a,a.exports,i),a.exports}(()=>{"use strict";i(293),i(652),i(37),i(6);var t=[{key:1,name:"艾露恩",image:"build/music_a7e9436348e6456eb47f32a75f7392370.jpeg",HP:t=>900+100*t,MP:t=>190+10*t,skill:[{name:"庇护 I",description:t=>`使用卡牌时, 回复 ${15*t} MP`,function:(t,e,i,s,n)=>{e.push({type:"cure-mp",target:"self",value:15*i.master.level})}},{name:"庇护 II",description:t=>`使用卡牌时, 回复 ${15*t} HP`,function:(t,e,i,s,n)=>{e.push({type:"cure-hp",target:"self",value:15*i.master.level})}}]},{key:2,name:"火焰领主",image:"build/music_b6f0b1c512ad42fab204d79b85d07c140.jpeg",HP:t=>900+100*t,MP:t=>190+10*t,skill:[{name:"欲火",description:t=>`使用火系卡牌时, 额外造成 ${15*t} 伤害`,function:(t,e,i,s,n)=>{"火"===t.race&&e.push({type:"hit",target:"opposite",value:15*-i.master.level})}}]}];t=t.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));var e=[{key:1,name:"小火把",type:"进攻卡",race:"火",limit:3,image:"build/music_88c8411d068c455099456851ec84f65c0.jpeg",description:t=>`造成 ${20*t+80} 伤害, 并附加给目标 1 层'燃'`,function:(t,e,i,s)=>[{type:"hit",target:"opposite",value:-(20*t.level+80)},{type:"buff",target:"opposite",value:"燃",number:1}]},{key:2,name:"大火把",type:"进攻卡",race:"火",limit:3,image:"build/music_2fec7f9242b44b64a914f7cc19d25abe0.jpeg",description:t=>`造成 ${10*t+40} 伤害, 并附加给目标 2 层'燃'`,function:(t,e,i,s)=>[{type:"hit",target:"opposite",value:-(10*t.level+40)},{type:"buff",target:"opposite",value:"燃",number:2}]},{key:3,name:"点燃",type:"魔法卡",race:"火",limit:3,image:"build/music_4d7f219082ba4d86b1543c982d1156560.jpeg",description:t=>`消耗 100 MP, 造成目标'燃'层数 * ${5*t+20} 伤害`,function:(t,e,i,s)=>e.MP<100?"MP 不足":[{type:"cost-mp",target:"self",value:-100},{type:"hit",target:"opposite",value:-i.master.buff.reduce(((t,e)=>"燃"===e?t+1:t),0)*t.level*5+20}]},{key:4,name:"火之纽带",type:"魔法卡",race:"火",limit:3,image:"build/music_6e9e96c75cf04411baa154b1d6a3c7360.jpeg",description:t=>`从牌库以及墓地抽取 1 张除自身外的火系卡牌, 回复 ${5*t+20} MP`,function:(t,e,i,s)=>{const n=[{type:"cure-mp",target:"self",value:5*t.level+20}],a=e.card.store.find((e=>"火"===e.race&&e.key!==t.key));a&&n.push({type:"pump-store-point",target:"self",value:[a]});const h=e.card.cemetery.find((e=>"火"===e.race&&e.key!==t.key));return h&&n.push({type:"pump-cemetery-point",target:"self",value:[h]}),n}},{key:5,name:"引燃",type:"魔法卡",race:"火",limit:3,image:"build/music_98a7a38ce58546a7841d18c96e41e3760.jpeg",description:t=>`消耗 20 MP, 造成 ${30*t+120} 伤害, 并消耗目标 1 层'燃'`,function:(t,e,i,s)=>e.MP<20?"MP 不足":i.master.buff.find((t=>"燃"===t))?[{type:"cost-mp",target:"self",value:-20},{type:"hit",target:"opposite",value:-(30*t.level+120)},{type:"cost-buff",target:"opposite",value:"燃",number:1}]:"目标'燃'印记不足"}];e=e.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));var s=[{name:"梦境 I",image:"build/music_47a83799595b4a5b97145a6e594620310.jpeg",boss:{master:{key:2,level:2},card:[{key:1,level:3,number:10},{key:2,level:3,number:10},{key:3,level:3,number:10}]},reward:()=>[{key:1,level:1,number:1},{key:2,level:1,number:1}],AI:(t,e,i)=>l(t.card.hand,1)}];s=s.map((t=>(t.imageDOM=new Image,t.imageDOM.src=t.image,t)));const n=(t,i)=>t.reduce(((t,s)=>{const n=[...t],a=e.find((t=>s.key===t.key));if(i){const t={...a,...s};delete t.number,n.push(...new Array(s.number).fill().map((e=>({...t}))))}return i||n.push({...a,...s}),n}),[]),a=e=>e.reduce(((e,i)=>{const s=[...e],n=t.find((t=>i.key===t.key));return s.push({...n,...i,HP:n.HP(i.level),MP:n.MP(i.level)}),s}),[]),h=t=>1===t?"I":2===t?"II":3===t?"III":4===t?"IV":5===t?"V":6===t?"VI":7===t?"VII":8===t?"VIII":9===t?"IX":10===t?"X":11===t?"XI":12===t?"XII":13===t?"XIII":14===t?"XIV":15===t?"XV":void 0,o=async t=>await new Promise((e=>setTimeout((()=>e()),t))),r=t=>Number(Number(t).toFixed(2)),l=(t,e)=>{var i=[],s=[...t];return new Array(e).fill().forEach((()=>{const t=Math.floor(Math.random()*s.length);s[t]&&(i.push(s[t]),s=s.filter(((e,i)=>i!==t)))})),i},c=t=>{for(var e=[],i=[...t];i.length;){const t=Math.floor(Math.random()*i.length);e.push(i[t]),i=i.filter(((e,i)=>i!==t))}return e},d=(t,e,i)=>{const s=t=>m(t,i)?e(t):null;canvas.addEventListener(t,s,{passive:!0}),Imitation.state.removeEventListener.push((()=>canvas.removeEventListener(t,s)))},u=(t,e)=>{const i=t=>e(t);canvas.addEventListener(t,i,{passive:!0}),Imitation.state.removeEventListener.push((()=>canvas.removeEventListener(t,i)))},m=(t,e)=>{const i=e.x,s=e.y,n=e.width,a=e.height,h=t.x||t.touches[0].clientX,o=t.y||t.touches[0].clientY;return h>=i&&h<=i+n&&o>=s&&o<=s+a},f=(t,e)=>{const{x:i,y:s,width:n,height:a}=t,{x:h,y:o,width:r,height:l}=e;return i+n>h&&i<h+r&&s+a>o&&s<o+l},w=t=>{const e=new Image;return e.src=t,e},g=canvas.getContext("2d"),p=(t,e)=>{const i=e.x,s=e.y,n=e.width,a=e.height;var h=0,o=0,r=t.width,l=t.height;const c=Math.max(n/t.width,a/t.height),d=t.width*c-n,u=t.height*c-a;d&&(h=d/2/c,r-=d/c),u&&(o=u/2/c,l-=u/c),g.drawImage(t,h,o,r,l,i,s,n,a)},y=t=>{const e=t.x,i=t.y,s=t.width,n=t.height,a=Array.isArray(t.radius)?t.radius:new Array(4).fill(t.radius);g.beginPath(),g.moveTo(e,i+a[0]),g.arcTo(e,i,e+a[0],i,a[0]),g.lineTo(e+s-a[1],i),g.arcTo(e+s,i,e+s,i+a[1],a[1]),g.lineTo(e+s,i+n-a[2]),g.arcTo(e+s,i+n,e+s-a[2],i+n,a[2]),g.lineTo(e+a[3],i+n),g.arcTo(e,i+n,e,i+n-a[3],a[3]),g.closePath()},x=t=>{const e=t.x,i=t.y,s=t.width,n=t.fontHeight;let a=t.text.split(""),h="",o=[];a.forEach((t=>{g.measureText(h).width>s&&(o.push(h),h=""),h+=t})),o.push(h),o.forEach(((t,s)=>{g.fillText(t,e,i+(s+1)*n)}))},v=canvas.getContext("2d"),I=w("build/music_8abd849fe01a4fb68dceacc6018190fc0.jpeg"),b=wx.getSystemInfoSync().windowWidth,S=wx.getSystemInfoSync().windowHeight,T=class{constructor(){this.opacity=0,this.count=0}render(){if(this.count<=20&&(this.opacity=r(this.opacity+.05),this.count=this.count+1),this.count>20&&this.count<=40&&(this.count=this.count+1),this.count>40&&this.count<=60&&(this.opacity=r(this.opacity-.05),this.count=this.count+1),this.count>60)return Imitation.state.page.current=Imitation.state.page.next,void(Imitation.state.page.next="");v.globalAlpha=this.opacity,p(I,{x:0,y:0,width:b,height:S}),v.globalAlpha=1}},A=canvas.getContext("2d");class P{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.radius=t.radius,this.font=t.font,this.fillStyle=t.fillStyle,this.text=t.text}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}render(){A.save(),A.textAlign="center",A.textBaseline="middle",A.font=this.font,A.fillStyle=this.fillStyle[0],y({x:this.x,y:this.y,width:this.width,height:this.height,radius:this.radius}),A.fill(),A.fillStyle=this.fillStyle[1],A.fillText(this.text,this.x+this.width/2,this.y+this.height/2),A.restore()}}canvas.getContext("2d");const M=w("build/music_56280e428411459c823ce172d97da20c0.jpeg"),k=wx.getSystemInfoSync().windowWidth,C=wx.getSystemInfoSync().windowHeight,R=class{constructor(){}drawButtonExplore(){const t={x:k/2-60,y:.6*C,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"探索"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="explore"}),t)}drawButtonStore(){const t={x:k/2-60,y:.6*C+60,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"编队"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="store"}),t)}drawButtonShop(){const t={x:k/2-60,y:.6*C+120,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"商店"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="shop"}),t)}drawBackground(){p(M,{x:0,y:0,width:k,height:C})}render(){this.drawBackground(),this.drawButtonExplore(),this.drawButtonStore(),this.drawButtonShop()}},E=canvas.getContext("2d");class ${constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.radius=t.radius,this.scrollX=t.scrollX||0,this.scrollY=t.scrollY||0,this.scrollPosition=[0,0],this.mouseDownPosition=null,this.clipFunction=()=>{const t={x:this.x,y:this.y,width:this.width,height:this.height,radius:this.radius};return y(t),t}}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}eventDown(t){try{this.mouseDownPosition=[t.x||t.touches[0].clientX,t.y||t.touches[0].clientY]}catch{}}eventUp(t){this.mouseDownPosition=null}eventMove(t){if(!this.mouseDownPosition)return;if(this.scrollX<=0&&this.scrollY<=0)return;clearTimeout(this.scrollbarTimeout),this.scrollbarTimeout=setTimeout((()=>this.scrollbarTimeout=null),1e3);const e=(t.pageX||t.targetTouches[0].pageX)-this.mouseDownPosition[0],i=(t.pageY||t.targetTouches[0].pageY)-this.mouseDownPosition[1];this.mouseDownPosition=[this.mouseDownPosition[0]+e,this.mouseDownPosition[1]+i];var s=this.scrollPosition[0]-e,n=this.scrollPosition[1]-i;this.scrollX>0&&(s<=0&&(s=0),s>this.scrollX&&(s=this.scrollX)),this.scrollY>0&&(n<=0&&(n=0),n>this.scrollY&&(n=this.scrollY)),this.scrollPosition=[s,n]}render(t){E.save();const e=this.clipFunction();E.clip(),t(this.scrollPosition),E.restore(),d("touchstart",this.eventDown.bind(this),e),u("touchmove",this.eventMove.bind(this)),u("touchend",this.eventUp.bind(this))}}const O="build/music_1c31bcc267a545ef971109512053f3e50.jpeg",B=canvas.getContext("2d"),D=w(O),H=wx.getSystemInfoSync().safeArea.top,F=wx.getSystemInfoSync().windowWidth,X=wx.getSystemInfoSync().windowHeight,Y=class{constructor(){this.explore,this.InstanceScroll,this.instance()}get scrollListHeight(){const t=this.explore.length;return 0===t?0:80*t+(t?12*(t-1):0)}instance(){this.explore=Imitation.state.explore,this.instanceScroll()}instanceScroll(){const t={x:12,y:60+H,width:F-24,height:X-72-H,radius:12,scrollbarHidden:!0};this.InstanceScroll=new $(t),this.InstanceScroll.scrollY=this.scrollListHeight-this.InstanceScroll.height}drawScrollBox(){this.InstanceScroll.render((t=>{const e=t[1];this.drawScrollContent(e)}))}drawScrollContent(t){B.textAlign="start",B.textBaseline="top",B.fillStyle="rgba(0, 0, 0, 1)",B.font=`900 12px ${window.fontFamily}`,this.explore.forEach(((e,i)=>{const s=60+92*i+H-t,n=F-24;f({x:12,y:s,width:n,height:80},this.InstanceScroll.option)&&(B.save(),y({x:12,y:s,width:n,height:80,radius:12}),B.clip(),p(e.imageDOM,{x:12,y:s,width:n,height:80}),B.fillText(e.name,24,s+12),B.restore(),d("touchstart",(()=>{this.enter(e)}),{x:12,y:s,width:n,height:80}))}))}drawButtonHome(){const t={x:12,y:12+H,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}drawBackground(){p(D,{x:0,y:0,width:F,height:X})}enter(t){Imitation.state.battle={self:{master:{...a([Imitation.state.info.library.master.find((t=>t.key===Imitation.state.info.team[Imitation.state.info.teamIndex].master[0].key))])[0],buff:[]},card:{team:n(Imitation.state.info.team[Imitation.state.info.teamIndex].card,!0),store:c(n(Imitation.state.info.team[Imitation.state.info.teamIndex].card,!0)),hand:[],cemetery:[],consume:[]}},opposite:{master:{...a([t.boss.master])[0],buff:[]},card:{team:n(t.boss.card,!0),store:c(n(t.boss.card,!0)),hand:[],cemetery:[],consume:[]},AI:t.AI},reward:n(t.reward())},Imitation.state.page.current="transition",Imitation.state.page.next="battle-pve"}render(){this.drawBackground(),this.drawButtonHome(),this.drawScrollBox()}},Q=canvas.getContext("2d"),j=w(O),L=wx.getSystemInfoSync().safeArea.top,_=wx.getSystemInfoSync().windowWidth,N=wx.getSystemInfoSync().windowHeight;class U{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.novaTime=0,this.card=t.card}render(){this.novaTime<1&&(this.novaTime=r(this.novaTime+.05));const t=this.x+this.offsetX,e=this.y+this.offsetY,i=this.width,s=this.height;Q.save(),Q.globalAlpha=this.novaTime,y({x:t,y:e,width:i,height:s,radius:.08*i}),Q.clip(),p(j,{x:t,y:e,width:i,height:s}),Q.restore()}}class W{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.novaTime=0,this.card=t.card,this.touchStart=t.touchStart,this.touchEnd=t.touchEnd,this.useAble=t.useAble,this.mouseDownPosition=null,this.ifTouchEndTime=0,this.mouseDownPositionTime=0,this.useAbleTime=0}get ifTouchEnd(){return this.offsetY<0-this.height/2}eventDown(t){try{this.mouseDownPosition=[t.x||t.touches[0].clientX,t.y||t.touches[0].clientY],this.touchStart()}catch{}}eventUp(t){this.ifTouchEnd&&this.touchEnd(),this.mouseDownPosition=null,this.offsetX=0,this.offsetY=0}eventMove(t){if(!this.mouseDownPosition)return;const e=(t.pageX||t.targetTouches[0].pageX)-this.mouseDownPosition[0],i=(t.pageY||t.targetTouches[0].pageY)-this.mouseDownPosition[1];this.mouseDownPosition=[this.mouseDownPosition[0]+e,this.mouseDownPosition[1]+i],this.offsetX=this.offsetX+e,this.offsetY=this.offsetY+i}render(){this.novaTime<1&&(this.novaTime=r(this.novaTime+.05)),this.mouseDownPosition&&this.mouseDownPositionTime<1&&(this.mouseDownPositionTime=r(this.mouseDownPositionTime+.05)),!this.mouseDownPosition&&this.mouseDownPositionTime>0&&(this.mouseDownPositionTime=0),this.ifTouchEnd&&this.ifTouchEndTime<1&&(this.ifTouchEndTime=r(this.ifTouchEndTime+.05)),!this.ifTouchEnd&&this.ifTouchEndTime>0&&(this.ifTouchEndTime=r(this.ifTouchEndTime-.05)),this.useAble&&this.useAbleTime<1&&(this.useAbleTime=r(this.useAbleTime+.05)),!this.useAble&&this.useAbleTime>0&&(this.useAbleTime=r(this.useAbleTime-.05));const t=this.card,e=.5*-this.width,i=.5*-this.height,s=this.width,n=this.height,a=this.x+this.offsetX+e*this.mouseDownPositionTime,o=this.y+this.offsetY+i*this.mouseDownPositionTime,l=this.width+s*this.mouseDownPositionTime,c=this.height+n*this.mouseDownPositionTime;Q.save(),Q.globalAlpha=this.novaTime,y({x:a,y:o,width:l,height:c,radius:.08*l}),this.ifTouchEndTime>0&&(Q.shadowBlur=.25*l*this.ifTouchEndTime,Q.shadowColor="rgba(0, 0, 0, 1)",Q.fill(),Q.shadowBlur=0),Q.clip(),p(this.card.imageDOM,{x:a,y:o,width:l,height:c});const m=c*this.mouseDownPositionTime,f=c*this.mouseDownPositionTime;if(y({x:a+(l-m)/2,y:o+(c-f)/2,width:m,height:f,radius:m/2}),Q.fillStyle="rgba(255, 255, 255, 0.5)",Q.fill(),1===this.mouseDownPositionTime&&(Q.textAlign="center",Q.textBaseline="middle",Q.font=`900 ${.07*l}px ${window.fontFamily}`,Q.fillStyle="rgba(0, 0, 0, 1)",Q.fillText(t.name,a+l/2,o+.12*l),t.number&&Q.fillText("X"+t.number,a+l-.12*l,o+.12*l),Q.textAlign="start",Q.fillText("Lv"+t.level,a+.08*l,o+.36*l),Q.fillText(`${t.race} · ${t.type}`,a+.08*l,o+.48*l),Q.textAlign="start",Q.textBaseline="top",x({x:a+.08*l,y:o+.6*l,width:l-.25*l,fontHeight:.105*l,text:t.description(1)})),0===this.mouseDownPositionTime){const e=.6*l,i=.2*l,s=a+l/2-e/2,n=o+c-i-(s-a),r=.08*l,d=[t.name,h(t.level)];t.number&&d.push("x"+t.number),y({x:s,y:n,width:e,height:i,radius:r}),Q.fillStyle="rgba(255, 255, 255, 0.5)",Q.fill(),Q.textAlign="center",Q.textBaseline="middle",Q.font=`900 ${.075*l}px ${window.fontFamily}`,Q.fillStyle="rgba(0, 0, 0, 1)",Q.fillText(d.join(" "),s+e/2,n+i/2)}Q.restore(),this.useAble&&(d("touchstart",this.eventDown.bind(this),{x:a,y:o,width:l,height:c}),u("touchmove",this.eventMove.bind(this)),u("touchend",this.eventUp.bind(this)))}}class V{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.type=t.type,this.information=t.information,this.env=t.env,this.useCard=t.useCard,this.InstanceCards=[],this.touchCard,this.show="card"}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawBackground(){const{x:t,y:e,width:i,height:s,information:n}=this;Q.save(),y({x:t,y:e,width:i,height:s,radius:this.width/2}),Q.clip(),p(n.master.imageDOM,{x:t,y:e,width:i,height:s}),Q.restore()}drawTitle(){Q.save();const{x:t,y:e,width:i,height:s,information:n}=this,a={width:.4*i,height:.12*i};a.x=t+i/2-a.width/2,a.y=e+.02*i,a.radius=a.height/4,a.text=[n.master.name,h(n.master.level)].join(" "),a.font=`900 ${.04*i}px ${window.fontFamily}`,a.fillStyle=["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],new P(a).render(),Q.restore()}drawHM(){const{x:t,y:e,width:i,height:s,information:n}=this,a={width:Math.min(.7*i,_/2-24),height:.12*i};a.y=e+s-a.height-.02*i,a.radius=a.height/2,a.x=t+i/2-a.width-.02*i,y(a),Q.textAlign="center",Q.textBaseline="middle",Q.font=`900 ${.04*i}px ${window.fontFamily}`,Q.fillStyle="rgba(185, 0, 0, 1)",Q.fill(),Q.fillStyle="rgba(255, 255, 255, 1)",Q.fillText(`HP ${n.master.HP}`,a.x+a.width/2,a.y+a.height/2),a.x=t+i/2+.02*i,y(a),Q.fillStyle="rgba(0, 0, 185, 1)",Q.fill(),Q.fillStyle="rgba(255, 255, 255, 1)",Q.fillText(`MP ${n.master.MP}`,a.x+a.width/2,a.y+a.height/2)}drawBuff(){const{x:t,y:e,width:i,height:s,information:n}=this;Q.textAlign="center",Q.textBaseline="middle",Q.fillStyle="rgba(0, 0, 0, 1)",Q.font=`900 ${.03*i}px ${window.fontFamily}`;var a=n.master.buff.reduce(((t,e)=>{const i=t.find((t=>t.name===e));return i&&(i.number=i.number+1),i||t.push({name:e,number:1}),t}),[{name:"BUFF"}]);a.forEach(((s,n)=>{const h={width:.16*i,height:.08*i,y:e+.15*i},o=n-(a.length/2-.5);h.radius=h.height/4,h.x=t+(i-h.width)/2+o*(h.width+.02*i),y(h),Q.fillStyle="rgba(0, 0, 0, 0.75)",Q.fill(),Q.fillStyle="rgba(255, 255, 255, 1)",Q.fillText(s.number?`${s.name} X${s.number}`:s.name,h.x+h.width/2,h.y+h.height/2)}))}drawCard(){const t=Math.min(2*this.width,_-24),e=this.height,i=this.x-(t-this.width)/2,s=this.y+.02*t;this.InstanceCards=this.InstanceCards.filter((t=>this.information.card.hand.find((e=>e===t.card)))),this.information.card.hand.forEach(((n,a)=>{const h=a-(this.information.card.hand.length/2-.5),o={width:t/4-4-t/48};o.height=1.35*o.width,o.x=i+(t-o.width)/2+h*(t/4-4),o.y=s+(e-o.height)/2,o.touchStart=()=>this.touchCard=n,o.touchEnd=()=>this.useCard(n,this),o.useAble=this.env.current===this;const r=this.InstanceCards.find((t=>t.card===n));if(r&&(r.x=o.x,r.useAble=o.useAble),!r){const t="self"===this.type?W:U;this.InstanceCards.push(new t({card:n,...o}))}})),this.InstanceCards.forEach((t=>t.card!==this.touchCard?t.render():null)),this.InstanceCards.forEach((t=>t.card===this.touchCard?t.render():null))}render(){this.drawBackground(),this.drawTitle(),this.drawHM(),this.drawCard(),this.drawBuff()}}class q{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.InstanceRoleSelf=t.InstanceRoleSelf,this.InstanceRoleOpposite=t.InstanceRoleOpposite,this.env=t.env,this.roundOver=t.roundOver,this.watchStore=t.watchStore,this.watchCemetery=t.watchCemetery,this.useAbleTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawEnv(){const t={x:this.x+12,y:this.y+this.height/2+12,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`ROUND ${this.env.round}`};new P(t).render()}drawButtonOverRound(){const t={x:this.x+this.width-84,y:this.y+this.height/2+12,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"结束回合"};new P(t).render(),1===this.useAbleTime&&d("touchstart",(()=>{this.roundOver()}),t)}drawButtonStore(){const t={x:this.x+12,y:this.y+this.height/2-40,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`查看牌库x${this.InstanceRoleSelf.information.card.store.length}`};new P(t).render(),1===this.useAbleTime&&d("touchstart",(()=>{this.watchStore()}),t)}drawButtonCemetery(){const t={x:this.x+96,y:this.y+this.height/2-40,width:72,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:`查看墓地x${this.InstanceRoleSelf.information.card.cemetery.length}`};new P(t).render(),1===this.useAbleTime&&d("touchstart",(()=>{this.watchCemetery()}),t)}drawBackground(){y({...this.option,radius:12,x:12,width:_-24}),Q.fillStyle="rgba(255, 255, 255, 0.5)",Q.fill()}render(){this.env.current===this.InstanceRoleSelf&&this.useAbleTime<1&&(this.useAbleTime=r(this.useAbleTime+.05)),this.env.current!==this.InstanceRoleSelf&&this.useAbleTime>0&&(this.useAbleTime=r(this.useAbleTime-.05)),this.drawBackground(),this.drawEnv(),this.drawButtonOverRound(),this.drawButtonStore(),this.drawButtonCemetery()}}class J{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.card=t.card}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}render(){const t=this.x+this.offsetX,e=this.y+this.offsetY,i=this.width,s=this.height,n=this.card;Q.save(),y({x:t,y:e,width:i,height:s,radius:.08*i}),Q.clip(),p(this.card.imageDOM,{x:t,y:e,width:i,height:s}),Q.fillStyle="rgba(255, 255, 255, 0.5)",Q.fill(),Q.fillStyle="rgba(0, 0, 0, 1)",Q.textAlign="center",Q.textBaseline="middle",Q.font=`900 ${.075*i}px ${window.fontFamily}`,Q.fillText(n.name,t+i/2,e+.12*i),n.number&&Q.fillText("X"+n.number,t+i-.12*i,e+.12*i),Q.textAlign="start",Q.fillText("Lv"+n.level,t+.08*i,e+.36*i),x({x:t+.08*i,y:e+.48*i,width:i-.25*i,fontHeight:.12*i,text:n.description(1)}),Q.restore()}}class z{constructor(t){this.cards=[],this.back=t.back,this.InstanceScroll,this.instanceScroll()}get cardHeight(){const t=Math.ceil(this.cards.length/4);return 0===t?0:(_-60)/4*1.35*t+(t?12*(t-1):0)}updateScrollY(){this.InstanceScroll.scrollY=this.cardHeight-this.InstanceScroll.height+12}instanceScroll(){const t={x:12,y:60+L,width:_-24,height:N-72-L,radius:12};y(t),Q.fillStyle="rgba(0, 0, 0, 1)",Q.fill(),this.InstanceScroll=new $(t)}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawCard(e)}))}drawCard(t){this.InstanceCard=this.cards.map(((t,e)=>{const i={width:(_-60)/4,card:t};return i.height=1.35*i.width,i.x=12+parseInt(e%4)*(i.width+12),i.y=60+parseInt(e/4)*(i.height+12)+L,new J(i)})),this.InstanceCard.forEach((e=>{f({...e.option,y:e.y-t},this.InstanceScroll.option)&&(e.offsetY=0-t,e.render())}))}drawButtonBack(){const t={x:12,y:12+L,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new P(t).render(),d("touchstart",(()=>{this.back()}),t)}render(){this.drawButtonBack(),this.drawScroll()}}class G{constructor(){this.over,this.reward}drawContent(){"win"===this.over&&(new P({x:12,y:12+L,width:_-24,height:36,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"战斗胜利"}).render(),this.reward.forEach(((t,e)=>{const i={width:(_-60)/4,card:t};i.height=1.35*i.width,i.x=12+parseInt(e%4)*(i.width+12),i.y=60+parseInt(e/4)*(i.height+12)+L,new J(i).render()}))),"lose"===this.over&&new P({x:12,y:12+L,width:_-24,height:36,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"战斗失败"}).render()}drawButtonExplore(){const t={x:_/2-60,y:.7*N,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"探索"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="explore"}),t)}drawButtonHome(){const t={x:_/2-60,y:.7*N+60,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"首页"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}render(){this.drawContent(),this.drawButtonExplore(),this.drawButtonHome()}}const K=class{constructor(){this.modal=null,this.over=null,this.env={round:0,current:null},this.InstanceRoleSelf,this.InstanceRoleOpposite,this.InstanceAction,this.InstanceModal,this.InstanceOver,this.instanceRoleSelf(),this.instanceRoleOpposite(),this.instanceAction(),this.instanceModal(),this.instanceOver(),this.initBattler()}initBattler(){new Array(3).fill().forEach((t=>{this.pumpCard(this.InstanceRoleSelf.information.card.store.shift(),this.InstanceRoleSelf),this.pumpCard(this.InstanceRoleOpposite.information.card.store.shift(),this.InstanceRoleOpposite)})),this.env.current=this.InstanceRoleSelf,this.roundStart()}instanceRoleSelf(){const t={width:Math.min(.75*_,.3*N),height:Math.min(.75*_,.3*N),type:"self",information:Imitation.state.battle.self,env:this.env,useCard:this.useCard};t.x=(_-t.width)/2,t.y=N-t.height-12,this.InstanceRoleSelf=new V(t)}instanceRoleOpposite(){const t={y:60+L,width:Math.min(.75*_,.3*N),height:Math.min(.75*_,.3*N),type:"opposite",information:Imitation.state.battle.opposite,env:this.env,useCard:this.useCard};t.x=(_-t.width)/2,t.y=60+L,this.InstanceRoleOpposite=new V(t)}instanceAction(){const t=_-24;this.InstanceAction=new q({x:(_-t)/2,y:L+48+this.InstanceRoleOpposite.height+(N-(L+48+this.InstanceRoleOpposite.height+this.InstanceRoleSelf.height)-120)/2,width:t,height:120,env:this.env,InstanceRoleSelf:this.InstanceRoleSelf,InstanceRoleOpposite:this.InstanceRoleOpposite,roundOver:this.roundOver,watchStore:()=>{this.modal=!0,this.InstanceModal.cards=this.InstanceRoleSelf.information.card.store,this.InstanceModal.updateScrollY()},watchCemetery:()=>{this.modal=!0,this.InstanceModal.cards=this.InstanceRoleSelf.information.card.cemetery,this.InstanceModal.updateScrollY()}})}instanceModal(){this.InstanceModal=new z({back:()=>this.modal=!1})}instanceOver(){this.InstanceOver=new G({})}drawRoleSelf(){this.InstanceRoleSelf.render()}drawRoleOpposite(){this.InstanceRoleOpposite.render()}drawAction(){this.InstanceAction.render()}drawModal(){this.InstanceModal.render()}drawOver(){this.InstanceOver.render()}drawBackground(){p(j,{x:0,y:0,width:_,height:N})}drawButtonHome(){const t={x:12,y:12+L,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}pumpCard=(t,e)=>{4===e.information.card.hand.length&&e.information.card.cemetery.push(t),e.information.card.hand.length<4&&e.information.card.hand.push(t)};useCard=async(t,e)=>{const[i,s]=e===this.InstanceRoleSelf?[this.InstanceRoleSelf,this.InstanceRoleOpposite]:[this.InstanceRoleOpposite,this.InstanceRoleSelf];var n=t.function(t,i.information,s.information,this.env);if("string"!=typeof n){for(i.information.master.skill.forEach((e=>{e.function(t,n,i.information,s.information,this.env)})),i.information.card.hand=i.information.card.hand.filter((e=>e!==t)),i.information.card.cemetery.push(t),i.information.card.consume.push(t),Imitation.state.function.message(t.name+" "+h(t.level),"rgba(125, 125, 125, 1)","rgba(255, 255, 255, 1)"),e===this.InstanceRoleSelf&&Imitation.state.function.animation("red-hit",(t=>[this.InstanceRoleOpposite.x+this.InstanceRoleOpposite.width/2-t.width/2,this.InstanceRoleOpposite.y+this.InstanceRoleOpposite.height/2-t.height/2])),e===this.InstanceRoleOpposite&&Imitation.state.function.animation("red-hit",(t=>[this.InstanceRoleSelf.x+this.InstanceRoleSelf.width/2-t.width/2,this.InstanceRoleSelf.y+this.InstanceRoleSelf.height/2-t.height/2]));n.length;){const t=n.shift();if("cost-mp"===t.type&&"self"===t.target&&(i.information.master.MP=i.information.master.MP+t.value),"hit"===t.type&&"opposite"===t.target&&(s.information.master.HP=s.information.master.HP+t.value),"buff"===t.type&&("self"===t.target&&i.information.master.buff.push(...new Array(t.number).fill(t.value)),"opposite"===t.target&&s.information.master.buff.push(...new Array(t.number).fill(t.value))),"cost-buff"===t.type){let e=0;"self"===t.target&&(i.information.master.buff=i.information.master.buff.filter((i=>i!==t.value||e===t.number||(e+=1,!1)))),"opposite"===t.target&&(s.information.master.buff=s.information.master.buff.filter((i=>i!==t.value||e===t.number||(e+=1,!1))))}"cure-hp"===t.type&&"self"===t.target&&(i.information.master.HP=i.information.master.HP+t.value),"cure-mp"===t.type&&"self"===t.target&&(i.information.master.MP=i.information.master.MP+t.value),"pump-store-positive"===t.type&&"self"===t.target&&new Array(t.value).fill().forEach((t=>{const e=this.InstanceRoleSelf.information.card.store.shift();e&&this.pumpCard(e,this.InstanceRoleSelf)})),"pump-store-point"===t.type&&"self"===t.target&&t.value.forEach((t=>{this.pumpCard(t,this.InstanceRoleSelf),this.InstanceRoleSelf.information.card.store=this.InstanceRoleSelf.information.card.store.filter((e=>e!==t))})),"pump-cemetery-positive"===t.type&&"self"===t.target&&new Array(t.value).fill().forEach((t=>{this.pumpCard(this.InstanceRoleSelf.information.card.cemetery.shift(),this.InstanceRoleSelf)})),"pump-cemetery-point"===t.type&&"self"===t.target&&t.value.forEach((t=>{this.pumpCard(t,this.InstanceRoleSelf),this.InstanceRoleSelf.information.card.cemetery=this.InstanceRoleSelf.information.card.cemetery.filter((e=>e!==t))}))}this.battlerOver()}else Imitation.state.function.message(n,"rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)")};roundStart=async()=>{if(new Array(1).fill().forEach((t=>{const e=this.env.current.information.card.store.shift();e&&this.pumpCard(e,this.env.current)})),this.env.current===this.InstanceRoleSelf&&(this.env.round=this.env.round+1),this.env.current===this.InstanceRoleOpposite){const t=this.InstanceRoleOpposite.information.AI(this.InstanceRoleOpposite.information,this.InstanceRoleSelf.information,this.env);for(;t.length;)await o(750),await this.useCard(t.shift(),this.InstanceRoleOpposite),await o(750);this.roundOver()}};roundOver=async()=>this.env.current===this.InstanceRoleSelf?(this.env.current=this.InstanceRoleOpposite,void await this.roundStart()):this.env.current===this.InstanceRoleOpposite?(this.env.current=this.InstanceRoleSelf,void await this.roundStart()):void 0;battlerOver=()=>{if(this.InstanceRoleOpposite.information.master.HP<=0){this.over="win",this.InstanceOver.reward=Imitation.state.battle.reward;const t=Imitation.state.info.library.card;return this.InstanceOver.reward.forEach((e=>{const i=t.find((t=>t.key===e.key));i&&(i.number=i.number+e.number),i||t.push({key:e.key,level:e.level,number:e.number})})),Imitation.state.function.saveInfo(),void(this.InstanceOver.over=this.over)}if(this.InstanceRoleSelf.information.master.HP<=0)return this.over="lose",void(this.InstanceOver.over=this.over)};render(){this.drawBackground(),this.modal&&this.drawModal(),this.over&&this.drawOver(),this.modal||this.over||(this.drawButtonHome(),this.drawAction(),this.drawRoleOpposite(),this.drawRoleSelf())}},Z=canvas.getContext("2d"),tt=w(O),et=wx.getSystemInfoSync().safeArea.top,it=wx.getSystemInfoSync().windowWidth,st=wx.getSystemInfoSync().windowHeight;class nt{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.card=t.card,this.touchEvent=t.touchEvent,this.touchDelayTime=t.touchDelayTime,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!m(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}render(){const t=this.x+this.offsetX,e=this.y+this.offsetY,i=this.width,s=this.height,n=this.card;Z.save(),y({x:t,y:e,width:i,height:s,radius:8}),Z.clip(),p(this.card.imageDOM,{x:t,y:e,width:i,height:s});const a=.75*i,o=.2*i,r=t+i/2-a/2,l=e+s-o-(r-t),c=o/4,m=[n.name,h(n.level)];n.number&&m.push("x"+n.number),y({x:r,y:l,width:a,height:o,radius:c}),Z.fillStyle="rgba(255, 255, 255, 0.5)",Z.fill(),Z.textAlign="center",Z.textBaseline="middle",Z.font=`900 ${.07*i}px ${window.fontFamily}`,Z.fillStyle="rgba(0, 0, 0, 1)",Z.fillText(m.join(" "),r+a/2,l+o/2),Z.restore(),d("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),u("touchmove",this.eventMove.bind(this)),u("touchend",this.eventUp.bind(this))}}class at{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.card=t.card,this.novaTime=0}render(){this.novaTime<1&&(this.novaTime=r(this.novaTime+.05));const t=this.x,e=this.y,i=this.width,s=this.height,n=this.card;Z.save(),y({x:t,y:e,width:i,height:s,radius:.08*i}),Z.clip(),p(this.card.imageDOM,{x:t,y:e,width:i,height:s});const a=s*this.novaTime,h=s*this.novaTime;y({x:t+(i-a)/2,y:e+(s-h)/2,width:a,height:h,radius:a/2}),Z.fillStyle="rgba(255, 255, 255, 0.5)",Z.fill(),Z.textAlign="center",Z.textBaseline="middle",Z.font=`900 ${.07*i}px ${window.fontFamily}`,Z.fillStyle="rgba(0, 0, 0, 1)",Z.fillText(n.name,t+i/2,e+.12*i),Z.textAlign="end",n.number&&Z.fillText("X"+n.number,t+i-.08*i,e+.3*i),Z.textAlign="start",Z.fillText("Lv "+n.level,t+.08*i,e+.3*i),Z.fillText(`${n.race} · ${n.type}`,t+.08*i,e+.42*i),Z.textAlign="start",Z.textBaseline="top",x({x:t+.08*i,y:e+.6*i,width:i-.25*i,fontHeight:.105*i,text:n.description(1)}),Z.restore()}}class ht{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.master=t.master,this.touchEvent=t.touchEvent,this.touchDelayTime=t.touchDelayTime,this.touchArea=t.touchArea,this.touchTimeout}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}eventDown(t){this.touchArea&&!m(t,this.touchArea)||(this.touchTimeout=!0)}eventUp(t){!0===this.touchTimeout&&this.touchEvent(),this.touchTimeout=!1}eventMove(t){this.touchTimeout=!1}render(){const t=this.x+this.offsetX,e=this.y+this.offsetY,i=this.width,s=this.height,n=this.master;Z.save(),y({x:t,y:e,width:i,height:s,radius:12}),Z.clip(),p(this.master.imageDOM,{x:t,y:e,width:i,height:s});const a=.85*s,o=.85*s,r=t+(s-o)/2,l=e+(s-o)/2;y({x:r,y:l,width:a,height:o,radius:a/2}),Z.fillStyle="rgba(255, 255, 255, 0.5)",Z.fill(),Z.textAlign="center",Z.textBaseline="middle",Z.font=`900 ${.1*s}px ${window.fontFamily}`,Z.fillStyle="rgba(0, 0, 0, 1)",Z.fillText([n.name,h(n.level)].join(" "),r+a/2,l+o/2),Z.restore(),d("touchstart",this.eventDown.bind(this),{x:t,y:e,width:i,height:s}),u("touchmove",this.eventMove.bind(this)),u("touchend",this.eventUp.bind(this))}}class ot{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.master=t.master,this.skillIndex=0,this.novaTime=0}get option(){return{x:this.x,y:this.y,width:this.width,height:this.height}}render(){this.novaTime<1&&(this.novaTime=r(this.novaTime+.05));const t=this.x,e=this.y,i=this.width,s=this.height,n=this.master;Z.save(),y({x:t,y:e,width:i,height:s,radius:.08*i}),Z.clip(),p(this.master.imageDOM,{x:t,y:e,width:i,height:s});const a=s*this.novaTime,h=s*this.novaTime;y({x:t+(i-a)/2,y:e+(s-h)/2,width:a,height:h,radius:a/2}),Z.fillStyle="rgba(255, 255, 255, 0.5)",Z.fill(),Z.textAlign="center",Z.textBaseline="middle",Z.font=`900 ${.07*i}px ${window.fontFamily}`,Z.fillStyle="rgba(0, 0, 0, 1)",Z.fillText(n.name,t+i/2,e+.12*i),Z.textAlign="start",Z.fillText("Lv "+n.level,t+.08*i,e+.3*i),Z.fillText("HP "+n.HP,t+.08*i,e+.42*i),Z.fillText("MP "+n.MP,t+.08*i,e+.54*i),Z.textAlign="start",Z.textBaseline="top",x({x:t+.08*i,y:e+.6*i,width:i-.25*i,fontHeight:.105*i,text:n.skill[this.skillIndex].description(n.level)}),Z.restore()}}const rt=class{constructor(){this.preview=null,this.type="team",this.sort="name",this.master,this.card,this.InstanceScroll,this.InstanceMaster,this.InstanceMasterPreview,this.InstanceCard,this.InstanceCardPreview,this.init(),this.instanceCardPreview(),this.instanceMasterPreview()}get bannerHeight(){return 160}get masterHeight(){const t=Math.ceil(this.master.length/4);return 0===t?-12:(it-60)/4*1.35*t+(t?12*(t-1):0)}get cardHeight(){const t=Math.ceil(this.card.length/4);return 0===t?0:(it-60)/4*1.35*t+(t?12*(t-1):0)}init(){"team"===this.type&&(this.master=a([Imitation.state.info.library.master.find((t=>t.key===Imitation.state.info.team[Imitation.state.info.teamIndex].master[0].key))]),this.card=n(Imitation.state.info.team[Imitation.state.info.teamIndex].card,!0),this.card=this.card.sort(((t,e)=>{const i=String(t[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0);return String(e[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0)-i}))),"library-card"===this.type&&(this.master=[],this.card=n(Imitation.state.info.library.card),this.card=this.card.sort(((t,e)=>{const i=String(t[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0);return String(e[this.sort]).split("").reduce(((t,e)=>t+String(e).charCodeAt(0)),0)-i}))),"library-master"===this.type&&(this.master=a(Imitation.state.info.library.master),this.card=[]),this.instanceScroll(),this.instanceMaster(),this.instanceCard()}instanceScroll(){const t={x:12,y:60+et,width:it-24,height:st-72-et,radius:12};this.InstanceScroll=new $(t),this.InstanceScroll.scrollY=this.bannerHeight+this.masterHeight+this.cardHeight-this.InstanceScroll.height+24}instanceMaster(){this.InstanceMaster=this.master.map(((t,e)=>{const i={width:it-24,master:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=(it-60)/4*1.35,i.x=12,i.y=72+e*(i.height+12)+this.bannerHeight+et,new ht(i)}))}instanceCard(){this.InstanceCard=this.card.map(((t,e)=>{const i={width:(it-60)/4,card:t,touchAble:!0,touchArea:this.InstanceScroll.option,touchEvent:()=>this.preview=t};return i.height=1.35*i.width,i.x=12+parseInt(e%4)*(i.width+12),i.y=84+parseInt(e/4)*(i.height+12)+this.bannerHeight+this.masterHeight+et,new nt(i)}))}instanceCardPreview(){const t={width:.7*it,card:this.preview};t.height=1.35*t.width,t.x=.15*it,t.y=(st-1.5*t.width)/2-60,this.InstanceCardPreview=new at(t)}instanceMasterPreview(){const t={width:.7*it,card:this.preview};t.height=1.35*t.width,t.x=.15*it,t.y=(st-1.5*t.width)/2-60,this.InstanceMasterPreview=new ot(t)}drawScroll(){this.InstanceScroll.render((t=>{const e=t[1];this.drawBanner(e),this.drawMaster(e),this.drawCard(e)}))}drawBanner(t){const e={x:12,y:60-t+et,width:it-24,height:this.bannerHeight,radius:12};f(e,this.InstanceScroll.option)&&(Z.save(),y(e),Z.fillStyle="rgba(0, 0, 0, 0.25)",Z.fill(),Z.clip(),(()=>{new Array(Imitation.state.info.team.length).fill().forEach(((t,i)=>{const s={x:24+72*i,y:12+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:[`rgba(255, 255, 255, ${i===Imitation.state.info.teamIndex?1:.5})`,"rgba(0, 0, 0, 1)"],text:`队伍 ${i+1}`};f(s,this.InstanceScroll.option)&&(new P(s).render(),d("touchstart",(t=>{m(t,this.InstanceScroll.option)&&(Imitation.state.info.teamIndex=i,this.type="team",this.init())}),s))}))})(),(()=>{new Array(...[["team","队伍"],["library-card","卡牌仓库"],["library-master","队长仓库"]]).forEach(((t,i)=>{const s={x:24+72*i,y:e.y+e.height-42,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:[`rgba(255, 255, 255, ${t[0]===this.type?1:.5})`,"rgba(0, 0, 0, 1)"],text:t[1]};f(s,this.InstanceScroll.option)&&(new P(s).render(),d("touchstart",(e=>{m(e,this.InstanceScroll.option)&&(this.type=t[0],this.init())}),s))}))})(),(()=>{new Array(...[["name","名称"],["level","等级"],["type","类型"],["race","种类"]]).forEach(((t,i)=>{const s={x:24+72*i,y:54+e.y,width:60,height:30,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:[`rgba(255, 255, 255, ${t[0]===this.sort?1:.5})`,"rgba(0, 0, 0, 1)"],text:t[1]};f(s,this.InstanceScroll.option)&&(new P(s).render(),d("touchstart",(e=>{m(e,this.InstanceScroll.option)&&(this.sort=t[0],this.init())}),s))}))})(),Z.restore())}drawCard(t){this.InstanceCard.forEach((e=>{f({...e.option,y:e.y-t},this.InstanceScroll.option)&&(e.offsetY=0-t,e.render())}))}drawMaster(t){this.InstanceMaster.forEach((e=>{f({...e.option,y:e.y-t},this.InstanceScroll.option)&&(e.offsetY=0-t,e.render())}))}drawPreview(){var t=[];const e=this.InstanceMasterPreview.y+this.InstanceMasterPreview.height;if("team"===this.type){if(this.InstanceCard.find((t=>t.card===this.preview))){this.InstanceCardPreview.card=this.preview,this.InstanceCardPreview.render();const i={x:it/2-60,y:e+40,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"卸载"};new P(i).render(),d("touchstart",(()=>{this.unloadCard(this.preview),this.preview=null,this.InstanceCardPreview.novaTime=0}),i),t.push(i)}this.InstanceMaster.find((t=>t.master===this.preview))&&(this.InstanceMasterPreview.master=this.preview,this.InstanceMasterPreview.render(),this.preview.skill.forEach(((i,s)=>{const n={x:it/2-40,y:e+20,width:80,height:32,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:[`rgba(255, 255, 255, ${s===this.InstanceMasterPreview.skillIndex?1:.5})`,"rgba(0, 0, 0, 1)"],text:i.name},a=this.preview.skill.length,h=(s-(a/2-.5))*n.width*1.1;n.x=n.x+h,new P(n).render(),d("touchstart",(t=>{this.InstanceMasterPreview.skillIndex=s}),n),t.push(n)})))}if("library-card"===this.type){this.InstanceCardPreview.card=this.preview,this.InstanceCardPreview.render();const i={x:it/2-60,y:e+40,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"装载"};new P(i).render(),d("touchstart",(()=>{this.loadCard(this.preview),this.preview=null,this.InstanceCardPreview.novaTime=0}),i),t.push(i);const s={x:it/2-60,y:e+100,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"合成"};new P(s).render(),d("touchstart",(()=>{this.composeCard(this.preview),this.preview=null,this.InstanceCardPreview.novaTime=0}),s),t.push(s)}if("library-master"===this.type){this.InstanceMasterPreview.master=this.preview,this.InstanceMasterPreview.render(),this.preview.skill.forEach(((i,s)=>{const n={x:it/2-40,y:e+20,width:80,height:32,radius:8,font:`900 10px ${window.fontFamily}`,fillStyle:[`rgba(255, 255, 255, ${s===this.InstanceMasterPreview.skillIndex?1:.5})`,"rgba(0, 0, 0, 1)"],text:i.name},a=this.preview.skill.length,h=(s-(a/2-.5))*n.width*1.1;n.x=n.x+h,new P(n).render(),d("touchstart",(t=>{this.InstanceMasterPreview.skillIndex=s}),n),t.push(n)}));const i={x:it/2-60,y:e+80,width:120,height:40,radius:8,font:`900 14px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"装载"};new P(i).render(),d("touchstart",(()=>{this.loadMaster(this.preview),this.preview=null,this.InstanceMasterPreview.novaTime=0}),i),t.push(i)}u("touchstart",(e=>{t.some((t=>m(e,t)))||(this.preview=null,this.InstanceMasterPreview.novaTime=0,this.InstanceCardPreview.novaTime=0)}))}drawBackground(){p(tt,{x:0,y:0,width:it,height:st})}drawButtonHome(){const t={x:12,y:12+et,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}composeCard(t){const e=Imitation.state.info.library.card,i=Imitation.state.info.team[Imitation.state.info.teamIndex].card,s=e.find((e=>e.key===t.key&&e.level===t.level)),n=e.find((e=>e.key===t.key&&e.level===t.level+1)),a=i.find((e=>e.key===t.key&&e.level===t.level));if(s.number<3)Imitation.state.function.message("卡牌数量不足","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)");else{if(s.number=s.number-3,0===s.number){const t=e.indexOf(s);e.splice(t,1)}if(n&&(n.number=n.number+1),n||e.push({key:t.key,level:t.level+1,number:1}),a&&(a.number>s.number&&(a.number=s.number),0===a.number)){const t=i.indexOf(a);i.splice(t,1)}this.init(),Imitation.state.function.message("合成成功","rgba(125, 125, 125, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo()}}loadCard(t){const e=Imitation.state.info.library.card,i=Imitation.state.info.team[Imitation.state.info.teamIndex].card,s=e.find((e=>e.key===t.key&&e.level===t.level)),n=i.find((e=>e.key===t.key&&e.level===t.level));i.reduce(((t,e)=>t+e.number),0)>40?Imitation.state.function.message("超出卡组数量限制","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):i.filter((e=>e.key===t.key)).reduce(((t,e)=>t+e.number),0)>=t.limit?Imitation.state.function.message("超出卡牌数量限制","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):n&&n.number===s.number?Imitation.state.function.message("卡组数量不足","rgba(255, 50 ,50, 1)","rgba(255, 255, 255, 1)"):(n&&(n.number=n.number+1),n||i.push({key:t.key,level:t.level,number:1}),this.init(),Imitation.state.function.message("装载成功","rgba(125, 125, 125, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo())}unloadCard(t){const e=Imitation.state.info.team[Imitation.state.info.teamIndex].card,i=e.find((e=>e.key===t.key&&e.level===t.level));if(i.number=i.number-1,0===i.number){const t=e.indexOf(i);e.splice(t,1)}this.init(),Imitation.state.function.message("卸载成功","rgba(125, 125, 125, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo()}loadMaster(t){Imitation.state.info.team[Imitation.state.info.teamIndex].master[0].key=t.key,this.init(),Imitation.state.function.message("装载成功","rgba(125, 125, 125, 1)","rgba(255, 255, 255, 1)"),Imitation.state.function.saveInfo()}render(){this.drawBackground(),this.preview&&this.drawPreview(),this.preview||(this.drawButtonHome(),this.drawScroll())}},lt=(canvas.getContext("2d"),w(O)),ct=wx.getSystemInfoSync().safeArea.top,dt=wx.getSystemInfoSync().windowWidth,ut=wx.getSystemInfoSync().windowHeight,mt=class{constructor(){}drawBackground(){p(lt,{x:0,y:0,width:dt,height:ut})}drawButtonHome(){const t={x:12,y:12+ct,width:72,height:36,radius:8,font:`900 12px ${window.fontFamily}`,fillStyle:["rgba(255, 255, 255, 1)","rgba(0, 0, 0, 1)"],text:"返回"};new P(t).render(),d("touchstart",(()=>{Imitation.state.page.current="transition",Imitation.state.page.next="home"}),t)}render(){this.drawBackground(),this.drawButtonHome()}},ft=canvas.getContext("2d"),wt=(wx.getSystemInfoSync().safeArea.top,wx.getSystemInfoSync().windowWidth),gt=wx.getSystemInfoSync().windowHeight;class pt{constructor(){this.message="",this.backgroundColor="rgba(255, 255, 255, 1)",this.textColor="rgba(0, 0, 0, 1)",this.timeout=750,this.timeoutRef=null,this.show=!1,this.opacity=0,this.width=wt-24,this.height=36,this.x=(wt-this.width)/2,this.y=gt-48}send(t,e="rgba(255, 255, 255, 1)",i="rgba(0, 0, 0, 1)"){clearTimeout(this.timeoutRef),this.message=t,this.backgroundColor=e,this.textColor=i,this.show=!0,this.timeoutRef=setTimeout((()=>{this.show=!1,this.timeoutRef=null}),this.timeout)}render(){this.show&&this.opacity<1&&(this.opacity=r(this.opacity+.05)),!this.show&&this.opacity>0&&(this.opacity=r(this.opacity-.05)),this.show&&this.y>gt-48&&(this.y=r(this.y-4)),!this.show&&this.y<gt&&(this.y=r(this.y+4)),(this.show||0!==this.opacity)&&(ft.save(),ft.globalAlpha=this.opacity,ft.textAlign="center",ft.textBaseline="middle",ft.font=`900 12px ${window.fontFamily}`,ft.fillStyle=this.backgroundColor,y({x:this.x,y:this.y,width:this.width,height:this.height,radius:12}),ft.fill(),ft.fillStyle=this.textColor,ft.fillText(this.message,this.x+this.width/2,this.y+this.height/2),ft.restore())}}class yt{constructor(){this.map={},this.audioQueue=new Array(8).fill().map((t=>new Audio))}play(t,e=!1){const i=this.audioQueue.find((t=>!t.playing));i.onended=()=>i.playing=!1,i.playing=!0,i.loop=e,i.src=this.map[t],i.play()}}const xt="build/0.png",vt="build/1.png",It="build/2.png",bt="build/3.png",St="build/4.png",Tt="build/5.png",At=canvas.getContext("2d");class Pt{constructor(){this.map={"red-hit":[xt,xt,vt,vt,It,It,bt,bt,St,St,Tt,Tt].map((t=>this.createImage(t)))},this.animationQueue=[]}createImage=t=>{const e=new Image;return e.src=t,e};play(t,e){this.animationQueue.push({index:0,imgs:this.map[t],option:e,option:e})}render(){this.animationQueue.forEach(((t,e)=>{const i=t.imgs[t.index];i&&(At.drawImage(i,...t.option(i)),t.index=t.index+1),i||this.animationQueue.splice(e,1)}))}}const Mt=canvas.getContext("2d");class kt{constructor(){this.width=300,this.height=450,canvas.width=Math.round(this.width*dpr),canvas.height=Math.round(this.height*dpr),canvas.style.width=this.width+"px",canvas.style.height=this.height+"px",canvas.getContext("2d").scale(dpr,dpr),this.cards=e,this.index=0,this.stop=!1}saveImage(t){const e=document.createElement("a");e.href=canvas.toDataURL(),e.download=t,e.click(),this.index=this.index+1,this.stop=!1}render(){if(!this.cards[this.index])return;const t=this.cards[this.index],e=this.width,i=this.height;y({x:0,y:0,width:e,height:i,radius:.08*e}),Mt.clip(),p(t.imageDOM,{x:0,y:0,width:e,height:i}),Mt.fillStyle="rgba(255, 255, 255, 1)",Mt.textAlign="center",Mt.textBaseline="middle",Mt.font=`900 ${.075*e}px ${window.fontFamily}`,Mt.fillText(t.name,0+e/2,0+.12*e),t.number&&Mt.fillText("X"+t.number,0+e-.12*e,0+.12*e),Mt.textAlign="start",Mt.fillText(`${t.race} · ${t.type}`,0+.08*e,0+.48*e),x({x:0+.08*e,y:0+.6*e,width:e-.25*e,fontHeight:.12*e,text:t.description(1)}),this.stop||(setTimeout((()=>this.saveImage("card-"+t.key)),1e3),this.stop=!0)}}const Ct=canvas.getContext("2d");new class{constructor(){this.loadingInformation=!1,this.animationFrameId,this.instance,this.instanceMessage=new pt,this.instanceSound=new yt,this.instanceAnimation=new Pt,this.ImitationInit(),this.loopStart()}render(){Ct.clearRect(0,0,canvas.width,canvas.height),Imitation.state.removeEventListener.forEach((t=>t())),Imitation.state.removeEventListener=[];const t=Imitation.state.page.map[Imitation.state.page.current];this.instance instanceof t||(this.instance=new t),this.instance.render(),this.instanceMessage.render(),this.instanceAnimation.render()}loopStart(){this.animationFrameId=requestAnimationFrame((()=>{this.render(),this.loopStart()}))}loopEnd(){cancelAnimationFrame(this.animationFrameId)}ImitationInit(){Imitation.state={page:{current:"explore",next:"",map:{"save-image":kt,transition:T,home:R,explore:Y,"battle-pve":K,store:rt,shop:mt}},removeEventListener:[],info:null,battle:null,explore:s,function:{render:this.render,loopStart:this.loopStart,loopEnd:this.loopEnd,message:(t,e,i)=>this.instanceMessage.send(t,e,i),sound:t=>this.instanceSound.play(t),animation:(t,e)=>this.instanceAnimation.play(t,e),saveInfo:()=>{localStorage.setItem("info",JSON.stringify(Imitation.state.info))}}},localStorage.removeItem("info");const i=localStorage.getItem("info");if(i&&(Imitation.state.info=JSON.parse(i)),!i){const i={library:{master:t.map((t=>({key:t.key,level:1}))),card:e.map((t=>({key:t.key,level:1,number:t.limit})))},team:[{master:[{key:1}],card:e.map((t=>({key:t.key,level:1,number:t.limit})))},{master:[{key:1}],card:[]},{master:[{key:1}],card:[]},{master:[{key:1}],card:[]}],teamIndex:0,gold_1:1e3,gold_2:1e3};Imitation.state.info=i,Imitation.state.function.saveInfo()}}}})()})();